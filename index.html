<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ultimate AI Pro</title>
    
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark-dimmed.min.css">

    <style>
        /* --- PREMIUM VARIABLES --- */
        :root {
            --bg: #09090b; /* Zinc-950 */
            --header-bg: rgba(9, 9, 11, 0.85);
            --surface: #18181b; /* Zinc-900 */
            --border: #27272a; /* Zinc-800 */
            --user-bubble: #2563eb; /* Blue-600 */
            --ai-bubble: #18181b;
            --accent: #10b981; /* Emerald-500 */
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --font-stack: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: var(--font-stack);
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 16px;
        }

        /* --- HEADER --- */
        header {
            height: 60px;
            padding: 0 20px;
            background: var(--header-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            position: absolute; top: 0; width: 100%;
        }

        .brand { 
            font-weight: 700; 
            font-size: 17px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            letter-spacing: -0.02em; 
        }

        .status-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 20px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent);
            border: 1px solid rgba(16, 185, 129, 0.2);
            transition: 0.3s;
        }

        .action-icon { opacity: 0.6; cursor: pointer; transition: 0.2s; font-size: 18px; }
        .action-icon:hover { opacity: 1; transform: scale(1.1); }

        /* --- CHAT FEED --- */
        #feed {
            flex: 1;
            overflow-y: scroll;
            padding: 80px 16px 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            scroll-behavior: smooth;
        }

        /* MESSAGES */
        .msg-row { display: flex; width: 100%; opacity: 0; animation: fadeUp 0.4s forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .u-row { justify-content: flex-end; }
        .a-row { justify-content: flex-start; }

        .msg {
            max-width: 90%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* User Bubble */
        .u-msg { 
            background: var(--user-bubble); 
            color: #fff; 
            border-bottom-right-radius: 4px;
        }

        /* AI Bubble */
        .a-msg { 
            background: var(--ai-bubble); 
            color: var(--text-main); 
            border-bottom-left-radius: 4px; 
            border: 1px solid var(--border);
        }

        /* --- MARKDOWN STYLING --- */
        .msg p { margin: 0 0 10px 0; }
        .msg p:last-child { margin: 0; }
        
        .msg strong { color: #fff; font-weight: 600; }
        .msg ul, .msg ol { margin: 8px 0; padding-left: 20px; color: var(--text-muted); }
        .msg li { margin-bottom: 4px; }

        /* Code Block "Mac Window" Style */
        .msg pre { 
            background: #0d0d0d !important; 
            border-radius: 12px; 
            margin: 12px 0; 
            border: 1px solid #333;
            overflow: hidden;
        }
        
        .code-header {
            background: #1f1f1f;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .dots { display: flex; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot.red { background: #ff5f56; }
        .dot.yellow { background: #ffbd2e; }
        .dot.green { background: #27c93f; }

        .copy-btn {
            background: transparent; border: none; color: #888;
            font-size: 11px; font-weight: 600; cursor: pointer;
            transition: 0.2s;
        }
        .copy-btn:hover { color: #fff; }

        .msg code { font-family: 'SF Mono', Consolas, monospace; font-size: 13px; }
        .msg pre > code { display: block; padding: 12px; overflow-x: auto; background: transparent; }
        
        /* Inline Code */
        .msg :not(pre) > code {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 6px;
            color: #fbbf24; /* Amber */
        }

        /* Images */
        .art-wrapper { position: relative; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); margin-top: 8px; }
        .art-result { width: 100%; display: block; aspect-ratio: 1/1; object-fit: cover; }
        .art-tag { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #fff; font-size: 10px; padding: 4px 8px; border-radius: 4px; backdrop-filter: blur(4px); }

        /* --- INPUT AREA --- */
        .input-container {
            background: var(--bg);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            display: flex;
            align-items: flex-end;
            gap: 12px;
            z-index: 50;
        }

        .textarea-wrapper {
            flex: 1;
            position: relative;
            background: var(--surface);
            border-radius: 24px;
            border: 1px solid var(--border);
            transition: border 0.2s;
        }
        .textarea-wrapper:focus-within { border-color: #555; }

        textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            padding: 14px 16px;
            font-size: 16px;
            line-height: 1.4;
            max-height: 150px;
            resize: none;
            font-family: inherit;
            border-radius: 24px;
        }

        #send-btn {
            width: 48px; height: 48px;
            border-radius: 50%;
            background: #fff;
            color: #000;
            border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s, background 0.2s;
        }
        #send-btn svg { width: 20px; height: 20px; fill: currentColor; margin-left: 2px; }
        #send-btn:active { transform: scale(0.92); }
        #send-btn:disabled { background: var(--surface); color: #555; cursor: not-allowed; }

        /* --- LOADING ANIMATION --- */
        .typing-indicator { display: flex; gap: 5px; padding: 4px 0; }
        .typing-indicator span { width: 6px; height: 6px; background: #555; border-radius: 50%; animation: pulse 1s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><path d="M12 12 2.1 12a10.1 10.1 0 0 0 9.9 10C12 22 22 12 12 12z"></path><path d="M12 2a10 10 0 0 1 10 10h-10V2z"></path></svg>
            <span>Ultimate AI</span>
        </div>
        <div id="status-badge" class="status-badge">READY</div>
        <div class="action-icon" onclick="clearChat()" title="Reset Chat">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </div>
    </header>

    <div id="feed">
        <div class="msg-row a-row">
            <div class="msg a-msg">
                <p><strong>System Online.</strong></p>
                <p>I am connected to Groq (Llama3), Gemini, and Flux (Art). How can I assist you with your projects today?</p>
            </div>
        </div>
    </div>

    <div class="input-container">
        <div class="textarea-wrapper">
            <textarea id="inp" rows="1" placeholder="Ask a question or 'Draw...'"></textarea>
        </div>
        <button id="send-btn">
            <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9L22 2"/></svg>
        </button>
    </div>

    <script src="env.js"></script>

    chatHistory.map(m => ({
                    role: m.role === "user" ? "user" : "model",
                    parts: [{ text: m.content }]
                }));
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${KEYS.GEMINI}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: parts })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return null; }
        }

        // --- API 3: FLUX ART ---
        async function generateArt(prompt) {
            try {
                // Remove trigger word for cleaner prompt
                const cleanPrompt = prompt.replace(/^(draw|image|generate|paint|lukis)\s/i, '');
                const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", {
                    headers: { Authorization: `Bearer ${KEYS.HF}`, "Content-Type": "application/json" },
                    method: "POST", body: JSON.stringify({ inputs: cleanPrompt }),
                });
                
                if (!res.ok) throw new Error();
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                
                const div = document.createElement('div');
                div.className = "msg-row a-row";
                div.innerHTML = `
                    <div class="msg a-msg" style="padding:0; background:transparent; border:none;">
                        <div class="art-wrapper">
                            <img src="${url}" class="art-result" onload="scrollToBottom()">
                            <div class="art-tag">FLUX.1</div>
                        </div>
                    </div>`;
                dom.feed.appendChild(div);
                scrollToBottom();
            } catch (e) {
                addMessage("⚠️ Art generation failed. Server busy.", 'ai');
            }
        }

        // --- UI UTILS ---
        function addMessage(text, sender) {
            const row = document.createElement('div');
            row.className = `msg-row ${sender === 'user' ? 'u-row' : 'a-row'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `msg ${sender === 'user' ? 'u-msg' : 'a-msg'}`;
            
            if (sender === 'ai') {
                // Render Markdown
                bubble.innerHTML = marked.parse(text);
                // Wrap Pre tags in Mac-style window
                bubble.querySelectorAll('pre').forEach(pre => {
                    const code = pre.querySelector('code').innerText;
                    const wrapper = document.createElement('div');
                    
                    // Create Header
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    header.innerHTML = `
                        <div class="dots"><div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div></div>
                        <button class="copy-btn">Copy</button>
                    `;
                    
                    // Copy Logic
                    header.querySelector('.copy-btn').onclick = function() {
                        navigator.clipboard.writeText(code);
                        this.innerText = 'Copied!';
                        setTimeout(() => this.innerText = 'Copy', 2000);
                    };

                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(header);
    <script>
        // --- CONFIGURATION ---
        const dom = {
            inp: document.getElementById('inp'),
            btn: document.getElementById('send-btn'),
            feed: document.getElementById('feed'),
            badge: document.getElementById('status-badge')
        };

        let chatHistory = [];
        let KEYS = { GROQ: "", GEMINI: "", HF: "" }; // Default empty keys

        // --- INIT CHECK ---
        window.onload = () => {
            // Check if env.js loaded CONFIG
            if (typeof CONFIG === 'undefined') {
                addMessage("⚠️ **System Error**: `env.js` file is missing or has a syntax error.", 'ai');
                addMessage("Please ensure `const CONFIG = { ... }` is defined correctly.", 'ai');
                setStatus("OFFLINE", "red");
            } else {
                KEYS = CONFIG;
                // Check if at least one key exists
                if (!KEYS.GROQ && !KEYS.GEMINI) {
                    addMessage("⚠️ **No Keys Found**: Connected, but Groq/Gemini keys are empty in `env.js`.", 'ai');
                    setStatus("NO KEYS", "orange");
                }
            }
        };

        marked.setOptions({
            highlight: (code, lang) => {
                const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                return highlight.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        // --- EVENT LISTENERS ---
        dom.inp.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        dom.inp.addEventListener('keydown', (e) => {
            if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSend(); }
        });

        dom.btn.addEventListener('click', handleSend);

        // --- CORE LOGIC ---
        async function handleSend() {
            const text = dom.inp.value.trim();
            if (!text) return;

            // 1. Check if we have keys before trying
            if (typeof CONFIG === 'undefined') {
                alert("Cannot send: env.js is missing.");
                return;
            }

            addMessage(text, 'user');
            dom.inp.value = '';
            dom.inp.style.height = 'auto';
            dom.inp.focus();

            const lower = text.toLowerCase();
            const artTrigger = /^(draw|image|generate|paint|lukis)\s/i.test(lower);

            if (artTrigger) {
                if (!KEYS.HF) {
                    addMessage("⚠️ **Error**: You are trying to generate art, but the `HF` key is missing in `env.js`.", 'ai');
                    return;
                }
                setStatus("PAINTING...", "#d946ef");
                await generateArt(text);
            } else {
                
                // Logic: Try Groq -> If fail/empty -> Try Gemini
                const hasGroq = KEYS.GROQ && KEYS.GROQ.length > 5;
                const hasGemini = KEYS.GEMINI && KEYS.GEMINI.length > 5;

                if (!hasGroq && !hasGemini) {
                    addMessage("⚠️ **Error**: Both Groq and Gemini keys are missing. I cannot reply.", 'ai');
                    return;
                }

                setStatus("THINKING...", "#fbbf24");
                const loaderId = addLoader();
                chatHistory.push({ role: "user", content: text });

                let response = null;

                // Priority 1: Groq
                if (hasGroq) {
                    response = await callGroq();
                }

                // Priority 2: Gemini (if Groq failed or is missing)
                if (!response && hasGemini) {
                    if (hasGroq) setStatus("SWITCHING...", "#f97316"); // Let user know we are trying backup
                    response = await callGemini();
                }

                removeLoader(loaderId);
                
                if (response) {
                    addMessage(response, 'ai');
                    chatHistory.push({ role: "assistant", content: response });
                    if(chatHistory.length > 20) chatHistory.splice(0, 2);
                } else {
                    addMessage("⚠️ **Connection Failed**: I have keys, but the servers are rejecting them. Please check if your API keys are correct.", 'ai');
                }
            }
            setStatus("READY", "#10b981");
        }

        // --- API 1: GROQ ---
        async function callGroq() {
            try {
                const messages = [
                    { role: "system", content: "You are an expert AI assistant. Use Markdown." },
                    ...chatHistory
                ];
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${KEYS.GROQ}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages, temperature: 0.7 })
                });
                if(!res.ok) throw new Error();
                const data = await res.json();
                return data.choices[0].message.content;
            } catch (e) { return null; }
        }

        // --- API 2: GEMINI ---
        async function callGemini() {
            try {
                const parts = chatHistory.map(m => ({
                    role: m.role === "user" ? "user" : "model",
                    parts: [{ text: m.content }]
                }));
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${KEYS.GEMINI}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: parts })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) { return null; }
        }

        // --- API 3: FLUX ART ---
        async function generateArt(prompt) {
            try {
                const cleanPrompt = prompt.replace(/^(draw|image|generate|paint|lukis)\s/i, '');
                const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", {
                    headers: { Authorization: `Bearer ${KEYS.HF}`, "Content-Type": "application/json" },
                    method: "POST", body: JSON.stringify({ inputs: cleanPrompt }),
                });
                if (!res.ok) throw new Error();
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                
                const div = document.createElement('div');
                div.className = "msg-row a-row";
                div.innerHTML = `<div class="msg a-msg" style="padding:0; background:transparent; border:none;"><div class="art-wrapper"><img src="${url}" class="art-result" onload="scrollToBottom()"><div class="art-tag">FLUX.1</div></div></div>`;
                dom.feed.appendChild(div);
                scrollToBottom();
            } catch (e) {
                addMessage("⚠️ Art server busy or Key invalid.", 'ai');
            }
        }

        // --- UI UTILS ---
        function addMessage(text, sender) {
            const row = document.createElement('div');
            row.className = `msg-row ${sender === 'user' ? 'u-row' : 'a-row'}`;
            const bubble = document.createElement('div');
            bubble.className = `msg ${sender === 'user' ? 'u-msg' : 'a-msg'}`;
            
            if (sender === 'ai') {
                bubble.innerHTML = marked.parse(text);
                bubble.querySelectorAll('pre').forEach(pre => {
                    // Simple Copy Button Logic for better performance
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.innerText = 'Copy';
                    btn.style.position = 'absolute';
                    btn.style.top = '10px';
                    btn.style.right = '10px';
                    btn.onclick = () => { navigator.clipboard.writeText(pre.innerText); btn.innerText = 'Copied!'; setTimeout(()=>btn.innerText='Copy', 2000); };
                    
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);
                    wrapper.appendChild(btn);
                });
            } else {
                bubble.innerText = text;
            }
            row.appendChild(bubble);
            dom.feed.appendChild(row);
            scrollToBottom();
        }

        function addLoader() {
            const id = "ldr-" + Date.now();
            const row = document.createElement('div');
            row.className = "msg-row a-row";
            row.id = id;
            row.innerHTML = `<div class="msg a-msg"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            dom.feed.appendChild(row);
            scrollToBottom();
            return id;
        }

        function removeLoader(id) { const el = document.getElementById(id); if(el) el.remove(); }
        function setStatus(text, color) { 
            dom.badge.innerText = text; 
            dom.badge.style.color = color; 
            dom.badge.style.borderColor = color; 
            dom.badge.style.background = color + '1a'; 
        }
        function scrollToBottom() { dom.feed.scrollTop = dom.feed.scrollHeight; }
        function clearChat() { chatHistory = []; dom.feed.innerHTML = ''; addMessage("Chat cleared.", 'ai'); }
    </script>

</body>
</html>
