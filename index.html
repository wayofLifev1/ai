<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Workspace</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        :root {
            --bg-body: #ffffff;
            --bg-sidebar: #f8f9fa;
            --text-main: #212529;
            --text-secondary: #6c757d;
            --primary: #0d6efd;
            --primary-hover: #0b5ed7;
            --border-color: #dee2e6;
            --user-msg-bg: #f0f2f5;
        }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            margin: 0;
            display: flex;
            height: 100vh;
            color: var(--text-main);
            overflow: hidden;
        }

        /* SIDEBAR */
        #sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease;
            position: absolute;
            height: 100%;
            z-index: 1000;
            transform: translateX(-100%);
        }
        @media (min-width: 768px) { #sidebar { position: relative; transform: translateX(0); } }
        #sidebar.open { transform: translateX(0); box-shadow: 4px 0 15px rgba(0,0,0,0.1); }

        .sidebar-header { padding: 20px; }
        .new-chat-btn {
            width: 100%; padding: 12px; background: var(--primary); color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item {
            padding: 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;
        }
        .history-item:hover { background: #e9ecef; }
        .history-item.active { background: #e7f1ff; color: var(--primary); font-weight: 600; }
        .delete-chat { opacity: 0; color: #dc3545; transition: opacity 0.2s; }
        .history-item:hover .delete-chat { opacity: 1; }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; }

        header {
            padding: 15px 25px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }

        #chatContainer {
            flex: 1; overflow-y: auto; padding: 30px;
            display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box;
        }

        .message-wrapper { display: flex; width: 100%; gap: 16px; opacity: 0; animation: fadeUp 0.3s forwards; }
        @keyframes fadeUp { to { opacity: 1; } }
        
        .avatar {
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            background: linear-gradient(135deg, #0d6efd, #6610f2); color: white;
        }
        .user .avatar { display: none; }
        .message { max-width: 85%; font-size: 1rem; line-height: 1.6; }
        .message.user { background: var(--user-msg-bg); padding: 12px 18px; border-radius: 12px; border-bottom-right-radius: 2px; margin-left: auto; }
        .message.ai { width: 100%; padding-top: 5px; }

        /* CODE BLOCKS */
        .code-block-wrapper { margin: 15px 0; border-radius: 8px; overflow: hidden; border: 1px solid #333; }
        .code-header { background: #252526; color: #ccc; padding: 6px 12px; font-size: 0.75rem; display: flex; justify-content: space-between; }
        pre { margin: 0; }
        code.hljs { padding: 15px; font-family: monospace; font-size: 0.9em; }

        /* INPUT AREA */
        .input-container { width: 100%; max-width: 900px; margin: 0 auto; padding: 20px 30px; position: relative; z-index: 50; }
        .input-box {
            background: white; border-radius: 16px; padding: 12px; display: flex; flex-direction: column;
            border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        /* FILE PREVIEW */
        .file-preview-card {
            display: none; align-items: center; gap: 12px; background: #f8f9fa; 
            border: 1px solid #e9ecef; padding: 8px 12px; border-radius: 8px; width: fit-content; margin-bottom: 8px;
        }
        .file-icon-box { width: 32px; height: 32px; background: #e7f1ff; color: #0d6efd; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .file-thumb { width: 32px; height: 32px; border-radius: 4px; object-fit: cover; }
        
        .input-row { display: flex; align-items: flex-end; gap: 10px; }
        textarea { flex: 1; border: none; resize: none; outline: none; height: 24px; max-height: 200px; font-family: inherit; font-size: 1rem; }
        
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 8px; border-radius: 50%; transition: 0.2s; display:flex; align-items:center; justify-content:center;}
        .icon-btn:hover { background: #f0f2f5; color: var(--text-main); }
        .icon-btn.send { background: var(--primary); color: white; }

        /* DRAG DROP */
        #dragOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(13, 110, 253, 0.05);
            z-index: 2000; display: none; justify-content: center; align-items: center; border: 3px dashed var(--primary); pointer-events: none;
        }
        #dragOverlay.active { display: flex; }
        .drop-message { background: white; padding: 20px 40px; border-radius: 12px; font-weight: 600; color: var(--primary); display: flex; flex-direction: column; align-items: center; }

        /* SETTINGS */
        #settingsPanel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .settings-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }
        .setting-field { margin-bottom: 15px; }
        .setting-field input, .setting-field textarea, .setting-field select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; }
        .save-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }

        /* LOADING */
        .cursor::after { content: "‚óè"; color: var(--primary); animation: blink 1s infinite; margin-left: 2px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>

<div id="dragOverlay">
    <div class="drop-message">
        <span class="material-icons-round" style="font-size: 48px;">cloud_upload</span>
        Drop file here
    </div>
</div>

<div id="sidebar">
    <div class="sidebar-header">
        <button class="new-chat-btn" onclick="startNewChat()">
            <span class="material-icons-round">add</span> New Chat
        </button>
    </div>
    <div class="history-list" id="historyList"></div>
    <div style="padding: 15px; border-top: 1px solid var(--border-color);">
        <button class="icon-btn" style="width: 100%; border-radius: 6px; justify-content: flex-start; gap: 10px; padding: 10px;" onclick="toggleSettings()">
            <span class="material-icons-round">settings</span> Settings
        </button>
    </div>
</div>

<div class="main-content">
    <header>
        <button class="icon-btn" onclick="document.getElementById('sidebar').classList.toggle('open')">
            <span class="material-icons-round">menu</span>
        </button>
        <span style="font-weight:700; font-size:1.2rem; color:var(--text-main);">AI Workspace</span>
        <button class="icon-btn" onclick="toggleSettings()"><span class="material-icons-round">bolt</span></button>
    </header>

    <div id="chatContainer">
        <div id="emptyState" style="text-align:center; margin-top:15vh;">
            <div style="width:80px; height:80px; background:linear-gradient(135deg, #0d6efd, #6610f2); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center;">
                <span class="material-icons-round" style="font-size:40px; color:white;">smart_toy</span>
            </div>
            <h1 style="margin:0; font-weight:700;">How can I help you?</h1>
        </div>
    </div>

    <div class="input-container">
        <div class="input-box">
            <div class="file-preview-card" id="filePreview">
                <div class="file-icon-box" id="fileIconBox"><span class="material-icons-round">description</span></div>
                <img id="imageThumb" class="file-thumb" style="display:none;">
                <div style="display:flex; flex-direction:column; max-width:200px;">
                    <span style="font-size:0.85rem; font-weight:500; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" id="fileName">file.txt</span>
                </div>
                <span class="material-icons-round" style="cursor:pointer; font-size:16px; color:#6c757d;" onclick="clearFile()">close</span>
            </div>

            <div class="input-row">
                <button class="icon-btn" onclick="document.getElementById('fileInput').click()"><span class="material-icons-round">attach_file</span></button>
                <textarea id="userInput" placeholder="Type a message..." rows="1" enterkeyhint="send"></textarea>
                <button class="icon-btn send" id="sendBtn" onclick="sendMessage()"><span class="material-icons-round">arrow_upward</span></button>
                <button class="icon-btn" id="stopBtn" onclick="stopGeneration()" style="display:none; color:#dc3545;"><span class="material-icons-round">stop</span></button>
            </div>
        </div>
    </div>
    <input type="file" id="fileInput" hidden onchange="handleFile(this.files)">
</div>

<div id="settingsPanel">
    <div class="settings-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">Configuration</h2>
            <button class="icon-btn" onclick="toggleSettings()"><span class="material-icons-round">close</span></button>
        </div>
        <div class="setting-field">
            <label>Provider</label>
            <select id="primaryProvider"><option value="groq">Groq</option><option value="hf">Hugging Face</option></select>
        </div>
        <div class="setting-field"><label>System Prompt</label><textarea id="sysPrompt" rows="3"></textarea></div>
        <div class="setting-field"><label>Groq API Key</label><input type="password" id="groqKey"></div>
        <div class="setting-field"><label>Hugging Face API Key</label><input type="password" id="hfKey"></div>
        <button class="save-btn" onclick="saveSettings()">Save & Close</button>
        <button onclick="hardReset()" style="width:100%; margin-top:10px; background:none; border:none; color:red; cursor:pointer;">Reset All Data (Fix Crash)</button>
    </div>
</div>

<script>
    // --- SAFE STARTUP CHECK ---
    window.onerror = function(msg, url, line) {
        alert("Startup Error: " + msg + "\n\n1. Check your internet connection.\n2. Try the 'Reset All Data' button in Settings if available.");
    };

    if (typeof marked === 'undefined') {
        document.getElementById('emptyState').innerHTML = `<h2 style="color:red">Error: No Internet</h2><p>Please connect to the internet to load the AI libraries.</p>`;
        throw new Error("Marked.js library failed to load");
    }

    // --- CONFIG & UTILS ---
    marked.setOptions({ breaks: true, highlight: (code) => hljs.highlightAuto(code).value });
    const renderer = new marked.Renderer();
    renderer.code = function(code, lang) {
        return `<div class="code-block-wrapper"><div class="code-header"><span>${lang||'text'}</span><button onclick="navigator.clipboard.writeText(decodeURIComponent('${encodeURIComponent(code)}'))" style="background:none;border:none;color:#ccc;cursor:pointer;">Copy</button></div><pre><code class="hljs ${lang||''}">${hljs.highlightAuto(code).value}</code></pre></div>`;
    };
    marked.use({ renderer });

    // --- STATE ---
    let chats = [];
    try {
        chats = JSON.parse(localStorage.getItem('chats') || '[]');
        if(!Array.isArray(chats)) throw new Error("Corrupted Data");
    } catch(e) {
        console.error("Data corruption detected. Resetting.");
        localStorage.removeItem('chats');
        chats = [];
    }
    
    let currentChatId = null;
    let currentAttachment = null;
    let abortController = null;
    const DEFAULT_SYS = "You are an expert AI assistant. Be helpful, precise, and use Markdown.";

    // --- DRAG & DROP ---
    const dragOverlay = document.getElementById('dragOverlay');
    document.body.addEventListener('dragenter', () => dragOverlay.classList.add('active'));
    dragOverlay.addEventListener('dragleave', (e) => { if(!e.relatedTarget) dragOverlay.classList.remove('active'); });
    document.body.addEventListener('dragover', e => e.preventDefault());
    document.body.addEventListener('drop', (e) => {
        e.preventDefault(); dragOverlay.classList.remove('active');
        handleFile(e.dataTransfer.files);
    });

    // --- FUNCTIONS ---
    function handleFile(files) {
        if(!files.length) return;
        const f = files[0];
        const reader = new FileReader();
        const isImg = f.type.startsWith('image/');
        reader.onload = (e) => {
            currentAttachment = { type: isImg ? 'image':'text', content: e.target.result };
            document.getElementById('filePreview').style.display = 'flex';
            document.getElementById('fileName').innerText = f.name;
            const thumb = document.getElementById('imageThumb');
            const icon = document.getElementById('fileIconBox');
            if(isImg) { thumb.src = e.target.result; thumb.style.display='block'; icon.style.display='none'; }
            else { thumb.style.display='none'; icon.style.display='flex'; }
        };
        isImg ? reader.readAsDataURL(f) : reader.readAsText(f);
    }

    function clearFile() {
        document.getElementById('fileInput').value = '';
        document.getElementById('filePreview').style.display = 'none';
        currentAttachment = null;
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if(!text && !currentAttachment) return;
        
        const tempImg = currentAttachment?.type === 'image' ? currentAttachment.content : null;
        const fullPrompt = text + (currentAttachment?.type === 'text' ? `\n\n[File]:\n${currentAttachment.content}` : '');
        
        appendMessage('user', text, tempImg);
        saveMsg('user', text, tempImg);
        
        input.value = ''; input.style.height='24px'; clearFile();
        toggleLoading(true);

        const provider = localStorage.getItem('cfg_provider') || 'groq';
        const key = provider==='groq' ? localStorage.getItem('cfg_groq_key') : localStorage.getItem('cfg_hf_key');
        
        if(!key) {
            appendMessage('ai', `**Error:** API Key missing for ${provider}. Check Settings.`);
            toggleLoading(false);
            return;
        }

        let aiText = "";
        appendMessage('ai', "", null, true);
        abortController = new AbortController();

        try {
            if(provider === 'groq' && !tempImg) {
                await streamGroq(key, fullPrompt, (chunk) => { aiText += chunk; updateStream(aiText); });
            } else {
                // HF or Groq w/ Image
                const activeKey = (provider==='groq' && tempImg) ? localStorage.getItem('cfg_hf_key') : key;
                if(!activeKey && provider==='groq') throw new Error("Need Hugging Face key for images!");
                
                const model = tempImg ? "meta-llama/Llama-3.2-11B-Vision-Instruct" : "mistralai/Mixtral-8x7B-Instruct-v0.1";
                aiText = await callHF(activeKey, model, fullPrompt, tempImg);
                updateStream(aiText);
            }
            saveMsg('ai', aiText);
        } catch(e) {
            if(e.name !== 'AbortError') updateStream(`**Error:** ${e.message}`);
        } finally { toggleLoading(false); }
    }

    async function streamGroq(key, prompt, onChunk) {
        const sys = localStorage.getItem('cfg_sys') || DEFAULT_SYS;
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST", headers: {"Authorization":`Bearer ${key}`, "Content-Type":"application/json"},
            body: JSON.stringify({model: "llama-3.3-70b-versatile", messages: [{role:"system",content:sys},{role:"user",content:prompt}], stream:true}),
            signal: abortController.signal
        });
        if(!res.ok) throw new Error("Groq API Error");
        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let buff = "";
        while(true) {
            const {done, value} = await reader.read();
            if(done) break;
            buff += dec.decode(value, {stream:true});
            const lines = buff.split("\n");
            buff = lines.pop();
            for(const line of lines) {
                if(line.startsWith("data: ") && line!=="data: [DONE]") {
                    try { const c = JSON.parse(line.substring(6)).choices[0]?.delta?.content||""; if(c) onChunk(c); } catch{}
                }
            }
        }
    }

    async function callHF(key, model, prompt, img) {
        const sys = localStorage.getItem('cfg_sys') || DEFAULT_SYS;
        const res = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
            method: "POST", headers: {"Authorization":`Bearer ${key}`, "Content-Type":"application/json"},
            body: JSON.stringify(img ? {inputs:prompt, image:img} : {inputs:`System:${sys}\nUser:${prompt}`, parameters:{max_new_tokens:2048, return_full_text:false}})
        });
        if(!res.ok) throw new Error(await res.text());
        const d = await res.json();
        return Array.isArray(d) ? d[0].generated_text : d.generated_text;
    }

    function appendMessage(role, text, img, stream=false) {
        document.getElementById('emptyState').style.display='none';
        const div = document.createElement('div');
        div.className = `message-wrapper ${role}`;
        div.innerHTML = (role==='ai'?'<div class="avatar"><span class="material-icons-round">smart_toy</span></div>':'') + 
                        `<div class="message ${role}">${img?`<img src="${img}" style="max-width:100%;border-radius:8px;margin-bottom:10px;display:block;">`:''}` +
                        `${role==='user'?text.replace(/\n/g,'<br>'):(stream?'<span class="cursor"></span>':marked.parse(text))}</div>`;
        document.getElementById('chatContainer').appendChild(div);
        scrollToBottom();
    }

    function updateStream(text) {
        const last = document.getElementById('chatContainer').lastElementChild.querySelector('.message');
        last.innerHTML = marked.parse(text) + '<span class="cursor"></span>';
        if(text.split('```').length%2!==0) last.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
        scrollToBottom();
    }

    function saveMsg(role, text, img) {
        if(!currentChatId) startNewChat();
        const c = chats.find(x => x.id === currentChatId);
        c.messages.push({role, text, image:img});
        if(role==='user' && c.messages.length===1) { c.title = text.slice(0,30); renderHistory(); }
        localStorage.setItem('chats', JSON.stringify(chats));
    }

    function startNewChat() {
        currentChatId = Date.now().toString();
        chats.unshift({id:currentChatId, title:'New Chat', messages:[]});
        document.getElementById('chatContainer').innerHTML = document.getElementById('emptyState').outerHTML;
        document.getElementById('emptyState').style.display='block';
        renderHistory();
    }
    
    function renderHistory() {
        const el = document.getElementById('historyList');
        el.innerHTML = '';
        chats.forEach(c => {
            const div = document.createElement('div');
            div.className = `history-item ${c.id===currentChatId?'active':''}`;
            div.innerHTML = `<span>${c.title}</span><span class="material-icons-round delete-chat" onclick="deleteChat('${c.id}', event)">delete</span>`;
            div.onclick = (e) => { if(!e.target.classList.contains('delete-chat')) loadChat(c.id); };
            el.appendChild(div);
        });
    }

    function loadChat(id) {
        currentChatId = id;
        const c = chats.find(x=>x.id===id);
        document.getElementById('chatContainer').innerHTML = '';
        if(c.messages.length) {
             document.getElementById('emptyState').style.display='none';
             c.messages.forEach(m => appendMessage(m.role, m.text, m.image));
        } else {
             document.getElementById('chatContainer').innerHTML = document.getElementById('emptyState').outerHTML;
             document.getElementById('emptyState').style.display='block';
        }
        renderHistory();
        if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
    }

    function deleteChat(id, e) {
        e.stopPropagation();
        if(confirm('Delete?')) {
            chats = chats.filter(x=>x.id!==id);
            localStorage.setItem('chats', JSON.stringify(chats));
            if(currentChatId===id) startNewChat(); else renderHistory();
        }
    }

    function hardReset() {
        if(confirm("This will delete all chat history to fix the app. Are you sure?")) {
            localStorage.clear();
            location.reload();
        }
    }

    function scrollToBottom() { const c=document.getElementById('chatContainer'); c.scrollTop=c.scrollHeight; }
    function toggleLoading(b) { document.getElementById('sendBtn').style.display=b?'none':'flex'; document.getElementById('stopBtn').style.display=b?'flex':'none'; }
    function stopGeneration() { if(abortController) abortController.abort(); toggleLoading(false); }
    function toggleSettings() { const s=document.getElementById('settingsPanel'); s.style.display=s.style.display==='flex'?'none':'flex'; }
    function saveSettings() {
        ['primaryProvider','sysPrompt','groqKey','hfKey'].forEach(id => localStorage.setItem('cfg_'+(id==='primaryProvider'?'provider':id==='sysPrompt'?'sys':id==='groqKey'?'groq_key':'hf_key'), document.getElementById(id).value));
        toggleSettings();
    }

    (function init() {
        document.getElementById('primaryProvider').value = localStorage.getItem('cfg_provider') || 'groq';
        document.getElementById('sysPrompt').value = localStorage.getItem('cfg_sys') || DEFAULT_SYS;
        document.getElementById('groqKey').value = localStorage.getItem('cfg_groq_key') || '';
        document.getElementById('hfKey').value = localStorage.getItem('cfg_hf_key') || '';
        
        const ta = document.getElementById('userInput');
        ta.addEventListener('input', function(){this.style.height='auto';this.style.height=this.scrollHeight+'px';if(!this.value)this.style.height='24px';});
        ta.addEventListener('keydown', e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});
        
        if(chats.length) renderHistory(); else startNewChat();
    })();
</script>
</body>
</html>
