<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gemini Workspace Pro + Video</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

<style>
    :root {
        --bg-body: #0f0f11;
        --bg-sidebar: #161618;
        --bg-surface: #1e1e20;
        --bg-input: #27272a;
        --border: #3f3f46;
        --accent: #3b82f6; /* Pro Blue */
        --accent-glow: rgba(59, 130, 246, 0.3);
        --text-main: #e4e4e7;
        --text-muted: #a1a1aa;
        --font-main: 'Inter', sans-serif;
        --font-code: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; }

    /* LAYOUT GRID */
    .app-container { display: grid; grid-template-columns: 260px 1fr 0px; width: 100%; height: 100%; transition: 0.3s ease; }
    .app-container.show-preview { grid-template-columns: 260px 1fr 45%; }

    /* SIDEBAR */
    .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 1rem; display: flex; flex-direction: column; gap: 1rem; z-index: 10; }
    .logo { font-weight: 600; display: flex; align-items: center; gap: 10px; font-size: 1rem; color: #fff; letter-spacing: -0.5px; }
    .btn-new { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; box-shadow: 0 4px 12px var(--accent-glow); }
    .btn-new:hover { filter: brightness(1.1); }
    
    .history { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
    .history-item { padding: 10px; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: 0.2s; }
    .history-item:hover { background: rgba(255,255,255,0.05); color: #fff; }

    /* CHAT AREA */
    .chat-area { display: flex; flex-direction: column; position: relative; background: var(--bg-body); }
    .header { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
    .model-badge { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; color: var(--text-muted); border: 1px solid var(--border); }

    #messages { flex: 1; overflow-y: auto; padding: 20px 10%; scroll-behavior: smooth; display: flex; flex-direction: column; gap: 20px; }
    
    .msg { display: flex; gap: 15px; max-width: 800px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .avatar { width: 30px; height: 30px; border-radius: 6px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; }
    .u-av { background: #52525b; color: white; }
    .a-av { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }

    .content { line-height: 1.6; font-size: 0.95rem; flex: 1; overflow-x: hidden; }
    .content p { margin-top: 0; }
    .content pre { background: #18181b; padding: 15px; border-radius: 8px; border: 1px solid #3f3f46; overflow-x: auto; margin: 10px 0; }
    .content code { font-family: var(--font-code); font-size: 0.85em; }

    /* INPUT AREA */
    .input-wrapper { padding: 20px; background: linear-gradient(to top, var(--bg-body) 80%, transparent); }
    .input-box { background: var(--bg-input); border: 1px solid var(--border); border-radius: 16px; padding: 12px; display: flex; flex-direction: column; gap: 10px; max-width: 800px; margin: 0 auto; transition: 0.2s; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .input-box:focus-within { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    
    .input-row { display: flex; align-items: flex-end; gap: 10px; }
    textarea { width: 100%; background: transparent; border: none; color: white; resize: none; font-family: inherit; font-size: 1rem; max-height: 200px; padding: 8px 0; }
    
    .icon-btn { color: var(--text-muted); background: none; border: none; padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
    .icon-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .send-btn { background: var(--accent); color: white; border-radius: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }

    /* PREVIEW PANE (PRO FEATURE) */
    .preview-pane { border-left: 1px solid var(--border); background: #000; display: flex; flex-direction: column; position: relative; }
    .preview-header { padding: 10px 15px; border-bottom: 1px solid var(--border); background: var(--bg-surface); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-muted); }
    #previewFrame { flex: 1; border: none; width: 100%; background: white; }
    
    /* SETTINGS MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal { background: var(--bg-surface); width: 400px; padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .field { margin-bottom: 15px; }
    .field label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
    .field input, .field select { width: 100%; background: var(--bg-body); border: 1px solid var(--border); padding: 10px; border-radius: 6px; color: white; font-family: inherit; }

    /* UTILS */
    .typing-indicator { font-size: 0.8rem; color: var(--text-muted); margin-left: 45px; margin-bottom: 10px; display: none; }
    .hidden { display: none; }
    
    /* VIDEO GENERATION BADGE */
    .gen-badge { display: inline-flex; align-items: center; gap: 4px; background: #22c55e; color: #000; font-size: 0.7rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-bottom: 8px; text-transform: uppercase; }

    /* MOBILE */
    @media(max-width: 800px) {
        .app-container { grid-template-columns: 1fr; }
        .sidebar { display: none; } /* Simplified for mobile */
        .app-container.show-preview { grid-template-columns: 1fr; } 
        .preview-pane { position: fixed; inset: 0; z-index: 50; }
        .preview-header .close-preview { display: block; }
    }
</style>
</head>
<body>

<div class="app-container" id="appLayout">
    
    <div class="sidebar">
        <div class="logo">
            <span class="material-icons-round" style="color:var(--accent);">auto_awesome</span>
            AI Workspace Pro
        </div>
        <button class="btn-new" onclick="newChat()">
            <span class="material-icons-round">add</span> New Project
        </button>
        <div class="field" style="margin-bottom:0;">
            <label>Mode</label>
            <select id="modeSelect" style="font-size:0.85rem;">
                <option value="chat">Standard Chat</option>
                <option value="coder">Pro Coder (Artifacts)</option>
                <option value="video">Video Generator (Canvas)</option>
            </select>
        </div>
        <div class="history" id="historyList">
            </div>
        <button class="icon-btn" onclick="toggleSettings()" style="display:flex; gap:10px; width:100%; border-radius:8px;">
            <span class="material-icons-round">settings</span> Settings
        </button>
    </div>

    <div class="chat-area">
        <header class="header">
            <span class="model-badge" id="activeModelBadge">Gemini 1.5 Pro</span>
            <div style="display:flex; gap:10px;">
                <button class="icon-btn" onclick="togglePreview()" title="Toggle Preview Pane">
                    <span class="material-icons-round">splitscreen</span>
                </button>
            </div>
        </header>

        <div id="messages">
            <div class="msg" style="justify-content:center; opacity:0.5; margin-top:10vh; text-align:center;">
                <div>
                    <h2 style="margin-bottom:10px;">Ready to create.</h2>
                    <p>Ask for code, analysis, or <b style="color:var(--accent)">generate a video animation</b>.</p>
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typing">Gemini is thinking...</div>

        <div class="input-wrapper">
            <div class="input-box">
                <div class="input-row">
                    <button class="icon-btn" onclick="triggerFile()">
                        <span class="material-icons-round">attach_file</span>
                    </button>
                    <textarea id="userInput" rows="1" placeholder="Type a message or describe a video..." onkeydown="handleKey(event)"></textarea>
                    <button class="icon-btn" onclick="startSpeech()" title="Voice Input" style="color:var(--accent);">
                        <span class="material-icons-round">mic</span>
                    </button>
                    <button class="send-btn" onclick="sendMessage()">
                        <span class="material-icons-round">arrow_upward</span>
                    </button>
                </div>
                <input type="file" id="fileInput" hidden onchange="alert('File attached (Mock)')">
            </div>
        </div>
    </div>

    <div class="preview-pane">
        <div class="preview-header">
            <span>LIVE PREVIEW / RENDER</span>
            <div style="display:flex; gap:10px;">
                <button class="icon-btn" onclick="downloadPreview()" title="Download">
                    <span class="material-icons-round">download</span>
                </button>
                <button class="icon-btn" onclick="togglePreview()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
        </div>
        <iframe id="previewFrame"></iframe>
    </div>

</div>

<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this) toggleSettings()">
    <div class="modal">
        <h3>Settings</h3>
        <div class="field">
            <label>Gemini API Key</label>
            <input type="password" id="apiKey" placeholder="Paste Key from aistudio.google.com">
        </div>
        <div class="field">
            <label>System Prompt</label>
            <input type="text" id="sysPrompt" value="You are an expert full-stack developer and creative artist.">
        </div>
        <button class="btn-new" onclick="saveSettings()">Save & Close</button>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let apiKey = localStorage.getItem("gemini_key") || "";
    let chatHistory = [];
    const md = window.marked;

    // --- DOM ELEMENTS ---
    const messagesDiv = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const previewFrame = document.getElementById('previewFrame');
    const appLayout = document.getElementById('appLayout');

    // --- INIT ---
    if (!apiKey) toggleSettings();

    // --- CORE FUNCTIONS ---

    function toggleSettings() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    }

    function saveSettings() {
        apiKey = document.getElementById('apiKey').value;
        localStorage.setItem("gemini_key", apiKey);
        toggleSettings();
    }

    function togglePreview(forceOpen = false) {
        if(forceOpen) {
            appLayout.classList.add('show-preview');
        } else {
            appLayout.classList.toggle('show-preview');
        }
    }

    function handleKey(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        // Auto-resize
        userInput.style.height = 'auto';
        userInput.style.height = userInput.scrollHeight + 'px';
    }

    function appendMessage(role, text, isHtml = false) {
        const div = document.createElement('div');
        div.className = 'msg';
        
        const avatar = document.createElement('div');
        avatar.className = `avatar ${role === 'user' ? 'u-av' : 'a-av'}`;
        avatar.innerHTML = role === 'user' ? 'U' : '<span class="material-icons-round" style="font-size:16px">auto_awesome</span>';
        
        const content = document.createElement('div');
        content.className = 'content';
        
        if (isHtml) {
            content.innerHTML = text;
        } else {
            content.innerText = text;
        }

        div.appendChild(avatar);
        div.appendChild(content);
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return content; // Return for streaming updates
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        if (!apiKey) { alert("Please set API Key in settings."); toggleSettings(); return; }

        userInput.value = '';
        userInput.style.height = 'auto';
        appendMessage('user', text);
        
        document.getElementById('typing').style.display = 'block';
        
        // Context Check: Is user asking for Video?
        const mode = document.getElementById('modeSelect').value;
        let systemInstruction = document.getElementById('sysPrompt').value;
        
        // PRO FEATURE: VIDEO LOGIC
        // Since we can't generate mp4 directly, we instruct the AI to write HTML5 Canvas/Animation code
        // which we then render in the preview pane effectively "Creating a video".
        if (mode === 'video' || text.toLowerCase().includes('video') || text.toLowerCase().includes('animation')) {
            systemInstruction += " IMPORTANT: The user wants a video/animation. You cannot generate .mp4 files. Instead, WRITE A COMPLETE, SELF-CONTAINED HTML/JS FILE using HTML5 Canvas or CSS Keyframes to RENDER the animation requested. Ensure it loops or plays automatically. DO NOT use external images unless standard placeholders. WRAP THE CODE IN ```html BLOCKS.";
        }

        // Build Payload
        const contents = [{ role: "user", parts: [{ text: systemInstruction + "\n\nUser Query: " + text }] }];

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: contents })
            });

            const data = await response.json();
            document.getElementById('typing').style.display = 'none';

            if (data.error) {
                appendMessage('ai', "Error: " + data.error.message);
                return;
            }

            const rawMarkdown = data.candidates[0].content.parts[0].text;
            
            // Render Response
            const aiContentDiv = appendMessage('ai', '', true); // Empty container
            
            // Markdown Parsing
            aiContentDiv.innerHTML = md.parse(rawMarkdown);
            
            // Syntax Highlight
            aiContentDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });

            // ARTIFACTS / VIDEO ENGINE LOGIC
            // Look for HTML code blocks to render in Preview Pane
            const htmlMatch = rawMarkdown.match(/```html\n([\s\S]*?)\n```/);
            if (htmlMatch) {
                const code = htmlMatch[1];
                updatePreview(code);
                togglePreview(true); // Open preview automatically
                
                // Add a badge saying "Rendering Video..."
                const badge = document.createElement('div');
                badge.className = 'gen-badge';
                badge.innerHTML = '<span class="material-icons-round" style="font-size:12px">play_circle</span> Generated Animation';
                aiContentDiv.prepend(badge);
            }

        } catch (err) {
            document.getElementById('typing').style.display = 'none';
            appendMessage('ai', "Network Error: " + err.message);
        }
    }

    function updatePreview(code) {
        const doc = previewFrame.contentWindow.document;
        doc.open();
        doc.write(code);
        doc.close();
    }

    function newChat() {
        messagesDiv.innerHTML = '<div class="msg" style="justify-content:center; opacity:0.5; margin-top:10vh; text-align:center;"><div><h2 style="margin-bottom:10px;">New Session</h2></div></div>';
    }

    // --- VOICE INPUT (PRO FEATURE) ---
    function startSpeech() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { alert("Browser does not support voice."); return; }
        
        const recognition = new SpeechRecognition();
        recognition.onstart = () => userInput.placeholder = "Listening...";
        recognition.onspeechend = () => userInput.placeholder = "Processing...";
        recognition.onresult = (event) => {
            userInput.value = event.results[0][0].transcript;
            userInput.placeholder = "Type a message...";
            userInput.focus();
        };
        recognition.start();
    }
</script>
</body>
</html>
