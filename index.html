<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Ultimate AI Pro</title>
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* --- HIGH END VARIABLES --- */
        :root {
            --bg: #000000;
            --surface: #121212;
            --surface-2: #1e1e1e;
            --accent: #3b82f6; /* Professional Blue */
            --accent-glow: rgba(59, 130, 246, 0.3);
            --text: #ffffff;
            --text-dim: #a1a1aa;
            --border: #27272a;
        }

        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif; 
            margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; 
        }

        /* HEADER */
        header {
            height: 60px; padding: 0 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(18,18,18,0.8); backdrop-filter: blur(20px); z-index: 50;
        }
        .brand { font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--accent); }
        .head-btn { background: none; border: none; font-size: 20px; padding: 8px; border-radius: 50%; cursor: pointer; }
        .head-btn:active { background: var(--surface-2); }

        /* CHAT FEED */
        #feed { 
            flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 20px; 
            scroll-behavior: smooth;
        }
        .msg-row { display: flex; width: 100%; }
        .user-row { justify-content: flex-end; }
        .ai-row { justify-content: flex-start; }
        
        .msg { 
            max-width: 85%; padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.6; 
            position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.2); word-wrap: break-word;
        }
        .user-msg { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .ai-msg { background: var(--surface-2); color: #ececec; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        
        /* ATTACHMENTS */
        .img-preview { width: 100%; border-radius: 12px; margin-top: 8px; display: block; max-width: 300px; }
        .user-upload { width: 100%; max-width: 200px; border-radius: 12px; margin-bottom: 5px; display: block; border: 1px solid rgba(255,255,255,0.2); }

        /* INPUT AREA */
        .input-area {
            background: var(--bg); border-top: 1px solid var(--border); padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; gap: 10px; z-index: 50;
        }
        .preview-zone { display: none; padding: 5px; }
        .preview-thumb { height: 60px; border-radius: 8px; border: 1px solid var(--accent); }
        
        .controls { display: flex; align-items: flex-end; gap: 10px; }
        
        .attach-btn, .mic-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); 
            background: var(--surface); color: var(--text-dim); display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; flex-shrink: 0;
        }
        .mic-active { color: #ef4444; border-color: #ef4444; background: rgba(239, 68, 68, 0.1); animation: pulse 1.5s infinite; }
        
        textarea {
            flex: 1; background: var(--surface); border: 1px solid var(--border); color: white;
            padding: 12px 16px; border-radius: 24px; font-size: 16px; resize: none; max-height: 120px; font-family: inherit;
        }
        
        #send-btn {
            width: 45px; height: 45px; border-radius: 50%; background: var(--accent); color: white; border: none;
            display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; flex-shrink: 0;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* MODAL */
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: var(--surface); padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; border: 1px solid var(--border); }
        .modal-box h2 { margin: 0 0 15px 0; font-size: 18px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; color: var(--text-dim); font-size: 12px; margin-bottom: 6px; }
        .input-group input { width: 100%; padding: 12px; background: black; border: 1px solid var(--border); color: white; border-radius: 10px; box-sizing: border-box; }
        
        .primary-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; margin-top: 10px; }
        .install-btn { width: 100%; padding: 14px; background: #10b981; color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; margin-top: 10px; display: none; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* Markdown */
        pre { background: #0d0d0d; padding: 10px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; }
        code { font-family: 'Fira Code', monospace; font-size: 13px; }
        
        .tts-btn { float: right; font-size: 12px; background: none; border: none; opacity: 0.5; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="modal">
        <div class="modal-box">
            <h2>‚öôÔ∏è System Settings</h2>
            
            <div class="input-group">
                <label>GROQ KEY (Fast Chat)</label>
                <input type="password" id="key-groq" placeholder="gsk_...">
            </div>
            <div class="input-group">
                <label>GEMINI KEY (Vision & Smart)</label>
                <input type="password" id="key-gemini" placeholder="AIza...">
            </div>
            <div class="input-group">
                <label>HUGGINGFACE KEY (Art)</label>
                <input type="password" id="key-hf" placeholder="hf_...">
            </div>

            <button class="primary-btn" onclick="saveKeys()">Save Settings</button>
            <button id="install-btn" class="install-btn">üì≤ Install App</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; padding:10px; background:none; border:none; color:#666; margin-top:10px">Close</button>
        </div>
    </div>

    <header>
        <div class="brand"><span>‚ú¶</span> Ultimate AI</div>
        <div style="display:flex; gap:5px">
            <button class="head-btn" onclick="clearChat()">üóëÔ∏è</button>
            <button class="head-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="feed">
        </div>

    <div class="input-area">
        <div id="preview-zone" class="preview-zone">
            <img id="preview-img" class="preview-thumb">
            <div style="font-size:12px; color:#666; margin-top:4px">Image attached</div>
        </div>

        <div class="controls">
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
            
            <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
            <button class="mic-btn" id="mic-btn" onclick="toggleVoice()">üéôÔ∏è</button>
            
            <textarea id="inp" rows="1" placeholder="Message..."></textarea>
            
            <button id="send-btn" onclick="handleSend()">‚û§</button>
        </div>
    </div>

    <script>
        // --- 1. SETUP & STATE ---
        const dom = {
            feed: document.getElementById('feed'),
            inp: document.getElementById('inp'),
            modal: document.getElementById('modal'),
            previewZone: document.getElementById('preview-zone'),
            previewImg: document.getElementById('preview-img'),
            micBtn: document.getElementById('mic-btn'),
            installBtn: document.getElementById('install-btn'),
            keys: {
                groq: document.getElementById('key-groq'),
                gemini: document.getElementById('key-gemini'),
                hf: document.getElementById('key-hf')
            }
        };

        let state = {
            keys: { groq: "", gemini: "", hf: "" },
            history: [],
            currentImage: null, // Base64 string of uploaded image
            installPrompt: null
        };

        // --- 2. INITIALIZATION ---
        window.onload = () => {
            // Load Keys
            const k = localStorage.getItem('uai_keys');
            if(k) {
                state.keys = JSON.parse(k);
                dom.keys.groq.value = state.keys.groq;
                dom.keys.gemini.value = state.keys.gemini;
                dom.keys.hf.value = state.keys.hf;
            } else {
                openSettings();
            }

            // Load Chat
            const h = localStorage.getItem('uai_history');
            if(h) {
                state.history = JSON.parse(h);
                state.history.forEach(msg => renderMessage(msg));
            } else {
                renderMessage({ role: 'ai', content: "Welcome. I am upgraded with Vision, Voice, and Professional Tools. \n\nClick üìé to upload images or üéôÔ∏è to speak." });
            }
        };

        // --- 3. INSTALL APP LOGIC (PWA) ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            state.installPrompt = e;
            // Show the install button in settings
            dom.installBtn.style.display = 'block';
            dom.installBtn.onclick = async () => {
                dom.installBtn.style.display = 'none';
                state.installPrompt.prompt();
                const choice = await state.installPrompt.userChoice;
                if(choice.outcome === 'accepted') {
                    renderMessage({role: 'ai', content: "App installing..."});
                }
                state.installPrompt = null;
            };
        });

        // --- 4. CORE FEATURES ---
        
        function openSettings() { dom.modal.style.display = 'flex'; }
        
        function saveKeys() {
            state.keys = {
                groq: dom.keys.groq.value.trim(),
                gemini: dom.keys.gemini.value.trim(),
                hf: dom.keys.hf.value.trim()
            };
            localStorage.setItem('uai_keys', JSON.stringify(state.keys));
            dom.modal.style.display = 'none';
            renderMessage({role: 'ai', content: "‚úÖ System Settings Updated."});
        }

        // Image Handling
        function handleFileSelect(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                state.currentImage = e.target.result; // Base64
                dom.previewImg.src = state.currentImage;
                dom.previewZone.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Voice Handling
        let recognition;
        function toggleVoice() {
            if(!('webkitSpeechRecognition' in window)) return alert("Voice not supported on this browser.");
            
            if(dom.micBtn.classList.contains('mic-active')) {
                recognition.stop();
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => dom.micBtn.classList.add('mic-active');
            recognition.onend = () => dom.micBtn.classList.remove('mic-active');
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                dom.inp.value += transcript + " ";
            };
            recognition.start();
        }

        // TTS
        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(u);
        }

        // --- 5. SEND LOGIC ---
        async function handleSend() {
            const text = dom.inp.value.trim();
            const hasImage = !!state.currentImage;
            
            if(!text && !hasImage) return;

            // 1. Render User Message
            const userMsg = { role: 'user', content: text, image: state.currentImage };
            renderMessage(userMsg);
            state.history.push(userMsg);
            saveHistory();

            // Clear Input UI
            dom.inp.value = '';
            dom.previewZone.style.display = 'none';
            state.currentImage = null;
            document.getElementById('file-input').value = ""; // Reset file input

            // 2. Determine Engine
            let response = null;
            
            // Check Keys
            if(!state.keys.groq && !state.keys.gemini) {
                renderMessage({role:'ai', content:"‚ö†Ô∏è No API Keys found. Please check Settings ‚öôÔ∏è."});
                return;
            }

            // Route Logic: Image = Gemini, Art = Flux, Text = Groq (preferred)
            const loader = showLoader();

            try {
                if(/^(draw|paint|generate image)/i.test(text)) {
                    // ART MODE
                    if(!state.keys.hf) throw new Error("Missing HuggingFace Key");
                    await generateArt(text);
                    removeLoader(loader);
                    return; // Art handles its own rendering
                } 
                else if (hasImage) {
                    // VISION MODE (Must use Gemini)
                    if(!state.keys.gemini) throw new Error("Image upload requires Gemini Key");
                    response = await callGeminiVision(text, userMsg.image);
                } 
                else {
                    // TEXT MODE
                    if(state.keys.groq) response = await callGroq();
                    else if(state.keys.gemini) response = await callGeminiText();
                }

                removeLoader(loader);
                
                if(response) {
                    const aiMsg = { role: 'ai', content: response };
                    renderMessage(aiMsg);
                    state.history.push(aiMsg);
                    saveHistory();
                }

            } catch(e) {
                removeLoader(loader);
                renderMessage({role:'ai', content: `‚ö†Ô∏è Error: ${e.message}`});
            }
        }

        // --- 6. API ENGINES ---
        
        async function callGroq() {
            const msgs = [{role:"system", content:"You are a helpful expert AI."}, ...state.history.map(m => ({role: m.role==='user'?'user':'assistant', content: m.content}))];
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST", headers: {Authorization: `Bearer ${state.keys.groq}`, "Content-Type": "application/json"},
                body: JSON.stringify({model: "llama-3.3-70b-versatile", messages: msgs})
            });
            return (await res.json()).choices[0].message.content;
        }

        async function callGeminiText() {
            const parts = state.history.map(m => ({role: m.role==='user'?'user':'model', parts:[{text: m.content || " "}]}));
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.keys.gemini}`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({contents: parts})
            });
            return (await res.json()).candidates[0].content.parts[0].text;
        }

        async function callGeminiVision(prompt, base64Image) {
            // Remove header "data:image/jpeg;base64,"
            const cleanBase64 = base64Image.split(',')[1];
            
            const body = {
                contents: [{
                    parts: [
                        { text: prompt || "Describe this image." },
                        { inlineData: { mimeType: "image/jpeg", data: cleanBase64 } }
                    ]
                }]
            };

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.keys.gemini}`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body)
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function generateArt(prompt) {
            const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", {
                method: "POST", headers: {Authorization: `Bearer ${state.keys.hf}`, "Content-Type": "application/json"},
                body: JSON.stringify({inputs: prompt.replace(/^(draw|paint|generate image)\s/i, '')})
            });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            
            const div = document.createElement('div');
            div.className = "msg-row ai-row";
            div.innerHTML = `<div class="msg ai-msg"><img src="${url}" class="img-preview"></div>`;
            dom.feed.appendChild(div);
            scrollToBottom();
        }

        // --- 7. UI HELPERS ---
        function renderMessage(msg) {
            const div = document.createElement('div');
            div.className = `msg-row ${msg.role === 'user' ? 'user-row' : 'ai-row'}`;
            
            let contentHtml = "";
            if(msg.image) contentHtml += `<img src="${msg.image}" class="user-upload">`;
            contentHtml += msg.role === 'ai' ? marked.parse(msg.content) : msg.content;
            
            // TTS Button for AI
            if(msg.role === 'ai') {
                contentHtml += `<button class="tts-btn" onclick="speak(this.parentElement.innerText)">üîä</button>`;
            }

            div.innerHTML = `<div class="msg ${msg.role === 'user' ? 'user-msg' : 'ai-msg'}">${contentHtml}</div>`;
            dom.feed.appendChild(div);
            
            // Highlight Code
            div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            scrollToBottom();
        }

        function showLoader() {
            const id = "ldr-" + Date.now();
            dom.feed.insertAdjacentHTML('beforeend', `<div id="${id}" class="msg-row ai-row"><div class="msg ai-msg">Thinking...</div></div>`);
            scrollToBottom();
            return id;
        }
        function removeLoader(id) { document.getElementById(id)?.remove(); }
        function scrollToBottom() { dom.feed.scrollTop = dom.feed.scrollHeight; }
        function saveHistory() { localStorage.setItem('uai_history', JSON.stringify(state.history)); }
        function clearChat() { 
            if(confirm("Clear history?")) { 
                state.history=[]; localStorage.removeItem('uai_history'); 
                dom.feed.innerHTML=''; 
            } 
        }

        // Input Auto-Resize
        dom.inp.addEventListener('input', function() {
            this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
        });
    </script>
</body>
</html>
