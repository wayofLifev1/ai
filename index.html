<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#141414">
    <title>Ai</title>
    
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- MOBILE LAYOUT FIXES --- */
        :root { --bg: #000; --panel: #111; --accent: #00ff88; --text: #fff; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; 
            /* 100dvh fixes the "address bar hides input" issue on phones */
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* HEADER */
        header { 
            padding: 15px 20px; 
            background: rgba(20,20,20,0.95); 
            border-bottom: 1px solid #333; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 60px;
            flex-shrink: 0;
        }
        .brand { font-weight: 800; font-size: 22px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }
        .badge { font-size: 10px; background: #222; padding: 4px 8px; border-radius: 6px; color: #888; border: 1px solid #333; font-weight: bold;}

        /* CHAT AREA */
        #feed { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
        }
        
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; line-height: 1.5; font-size: 16px; word-wrap: break-word; }
        .u-msg { align-self: flex-end; background: #222; color: #fff; border: 1px solid #333; border-bottom-right-radius: 4px; }
        .a-msg { align-self: flex-start; background: transparent; border: 1px solid #333; color: #ddd; border-bottom-left-radius: 4px; }
        .art-img { width: 100%; border-radius: 12px; margin-top: 5px; border: 2px solid #d946ef; }

        /* INPUT AREA */
        .input-area { 
            padding: 10px 15px; 
            background: var(--panel); 
            display: flex; 
            gap: 10px; 
            border-top: 1px solid #333; 
            align-items: center;
            /* Fix for iPhone notches */
            padding-bottom: env(safe-area-inset-bottom, 20px);
            flex-shrink: 0;
        }
        
        input { 
            flex: 1; 
            padding: 12px 20px; 
            border-radius: 25px; 
            border: 1px solid #333; 
            background: #000; 
            color: white; 
            outline: none; 
            font-size: 16px; 
        }
        input:focus { border-color: var(--accent); }
        
        button { 
            width: 48px; height: 48px; 
            border-radius: 50%; 
            border: none; 
            background: white; 
            color: black; 
            font-size: 20px; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        button:active { transform: scale(0.9); background: var(--accent); }
    </style>
</head>
<body>

    <header>
        <div class="brand"><div class="dot"></div>Ai</div>
        <div class="badge" id="badge">ONLINE</div>
    </header>

    <div id="feed">
        <div class="msg a-msg">
            <p>Halo. Saya Ai.</p>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="inp" placeholder="Mesej..." autocomplete="off">
        <button id="btn">➤</button>
    </div>

    <script src="env.js"></script> 

    <script>
        // --- RESTORED SERVICE WORKER (For Install) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('PWA Registered'))
                    .catch(err => console.log('PWA Fail:', err));
            });
        }

        // --- SETUP DOM ---
        const inp = document.getElementById('inp');
        const btn = document.getElementById('btn');
        const feed = document.getElementById('feed');
        const badge = document.getElementById('badge');

        // --- KEY CHECK (Prevents "Unclickable" buttons) ---
        let KEYS = {};
        if (typeof CONFIG === 'undefined') {
            console.error("env.js not loaded!");
            addMsg("⚠️ Error: env.js missing. Keys not found.", 'a-msg');
            btn.disabled = true; // Disable button if broken
        } else {
            KEYS = { GROQ: CONFIG.GROQ, HF: CONFIG.HF, GEMINI: CONFIG.GEMINI };
        }

        // --- EVENT LISTENERS ---
        inp.addEventListener("keypress", (e) => { if(e.key === "Enter") handleSend(); });
        btn.addEventListener("click", handleSend);

        // --- MAIN FUNCTION ---
        async function handleSend() {
            const text = inp.value.trim();
            if (!text) return; 

            addMsg(text, 'u-msg');
            inp.value = '';
            
            const isArt = ["draw", "paint", "lukis", "gambar"].some(k => text.toLowerCase().startsWith(k));

            if (isArt) {
                updateStatus("PAINTING...", "#d946ef");
                await generateArt(text);
            } else {
                updateStatus("THINKING...", "#00ff88");
                // Try Groq, Fallback to Gemini
                if (!(await tryGroq(text))) {
                    updateStatus("SWITCHING...", "#f59e0b");
                    await tryGemini(text);
                }
            }
            updateStatus("ONLINE", "#333");
        }

        // --- AI ENGINES ---
        async function tryGroq(prompt) {
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${KEYS.GROQ}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role: "user", content: prompt}] })
                });
                if(!res.ok) throw new Error("Busy");
                const data = await res.json();
                addMsg(marked.parse(data.choices[0].message.content), 'a-msg', true);
                return true;
            } catch (e) { return false; }
        }

        async function tryGemini(prompt) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${KEYS.GEMINI}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                addMsg(marked.parse(data.candidates[0].content.parts[0].text), 'a-msg', true);
            } catch (e) { addMsg("⚠️ Offline/Error.", 'a-msg'); }
        }

        async function generateArt(prompt) {
            try {
                const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-dev", {
                    headers: { Authorization: `Bearer ${KEYS.HF}`, "Content-Type": "application/json" },
                    method: "POST",
                    body: JSON.stringify({ inputs: prompt }),
                });
                if (!res.ok) throw new Error("Busy");
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                feed.innerHTML += `<div class="msg a-msg" style="border:none"><img src="${url}" class="art-img" onload="this.scrollIntoView()"></div>`;
                feed.scrollTop = feed.scrollHeight;
            } catch (e) { addMsg("⚠️ Art busy.", 'a-msg'); }
        }

        // --- UTILS ---
        function addMsg(text, type, isHtml) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = isHtml ? text : text;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        function updateStatus(text, color) {
            badge.innerText = text;
            if(color !== "#333") badge.style.color = color;
        }
    </script>
</body>
</html>
