<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="theme-color" content="#000000">
    <title>Ultimate AI: Standalone</title>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --bg: #000000;
            --surface: #1c1c1e;
            --blue: #0a84ff;
            --text: #ffffff;
            --dim: #8e8e93;
            --border: #38383a;
        }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }

        /* HEADER */
        header {
            height: 55px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
            background: rgba(28, 28, 30, 0.8); backdrop-filter: blur(20px); z-index: 10;
        }
        .title { font-weight: 700; font-size: 16px; letter-spacing: -0.5px; }
        .btn-icon { background: none; border: none; font-size: 20px; cursor: pointer; padding: 5px; }

        /* CHAT AREA */
        #feed { flex: 1; overflow-y: auto; padding: 20px 15px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.5; word-wrap: break-word; }
        .user { align-self: flex-end; background: var(--blue); color: white; border-bottom-right-radius: 4px; }
        .ai { align-self: flex-start; background: var(--surface); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        /* Markdown Styles */
        .ai pre { background: #111; padding: 10px; border-radius: 8px; overflow-x: scroll; border: 1px solid #333; }
        .ai code { font-family: monospace; font-size: 13px; }
        .ai p { margin: 0 0 8px 0; } .ai p:last-child { margin: 0; }

        /* INPUT AREA */
        .input-box {
            padding: 10px 16px; border-top: 1px solid var(--border); background: var(--bg);
            display: flex; gap: 10px; align-items: flex-end; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        textarea {
            flex: 1; background: var(--surface); border: 1px solid var(--border); color: white;
            padding: 10px 14px; border-radius: 20px; font-size: 16px; resize: none; max-height: 100px; font-family: inherit;
        }
        #send-btn {
            background: var(--blue); border: none; width: 40px; height: 40px; border-radius: 50%;
            color: white; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }

        /* SETTINGS MODAL */
        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #1c1c1e; width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; border: 1px solid #444;
        }
        .modal-content h2 { margin-top: 0; font-size: 18px; }
        .field { margin-bottom: 15px; }
        .field label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        .field input { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box;}
        .save-btn { width: 100%; padding: 12px; background: var(--blue); border: none; color: white; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .close-btn { width: 100%; padding: 10px; background: transparent; border: none; color: #888; margin-top: 10px; }

        .img-result { width: 100%; border-radius: 12px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è API Settings</h2>
            <div class="field">
                <label>GROQ API KEY (Recommended)</label>
                <input type="password" id="key-groq" placeholder="gsk_...">
            </div>
            <div class="field">
                <label>GEMINI API KEY</label>
                <input type="password" id="key-gemini" placeholder="AIza...">
            </div>
            <div class="field">
                <label>HUGGINGFACE KEY (For Art)</label>
                <input type="password" id="key-hf" placeholder="hf_...">
            </div>
            <button class="save-btn" onclick="saveKeys()">Save & Connect</button>
            <button class="close-btn" onclick="toggleModal(false)">Close</button>
        </div>
    </div>

    <header>
        <div class="title">Ultimate AI</div>
        <div style="display:flex; gap:10px">
            <button class="btn-icon" onclick="clearChat()">üóëÔ∏è</button>
            <button class="btn-icon" onclick="toggleModal(true)">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="feed">
        </div>

    <div class="input-box">
        <textarea id="inp" rows="1" placeholder="Type a message..."></textarea>
        <button id="send-btn" onclick="handleSend()">‚û§</button>
    </div>

    <script>
        // --- 1. SETUP ---
        const dom = {
            feed: document.getElementById('feed'),
            inp: document.getElementById('inp'),
            modal: document.getElementById('modal'),
            inputs: {
                groq: document.getElementById('key-groq'),
                gemini: document.getElementById('key-gemini'),
                hf: document.getElementById('key-hf')
            }
        };

        let keys = { groq: '', gemini: '', hf: '' };
        let history = [];

        // --- 2. INITIALIZATION ---
        window.onload = () => {
            // Load Keys from Phone Storage
            const savedKeys = localStorage.getItem('ai_keys');
            if (savedKeys) {
                keys = JSON.parse(savedKeys);
                dom.inputs.groq.value = keys.groq || '';
                dom.inputs.gemini.value = keys.gemini || '';
                dom.inputs.hf.value = keys.hf || '';
            } else {
                // If no keys, show modal immediately
                toggleModal(true);
            }

            // Load Chat History
            const savedChat = localStorage.getItem('ai_chat_v3');
            if (savedChat) {
                history = JSON.parse(savedChat);
                history.forEach(msg => renderMessage(msg.content, msg.role, false));
            } else {
                renderMessage("Welcome. Click ‚öôÔ∏è to set your API keys.", "ai");
            }
        };

        // --- 3. KEY MANAGEMENT ---
        function toggleModal(show) {
            dom.modal.style.display = show ? 'flex' : 'none';
        }

        function saveKeys() {
            keys = {
                groq: dom.inputs.groq.value.trim(),
                gemini: dom.inputs.gemini.value.trim(),
                hf: dom.inputs.hf.value.trim()
            };
            localStorage.setItem('ai_keys', JSON.stringify(keys));
            toggleModal(false);
            renderMessage("‚úÖ Keys saved locally.", "ai");
        }

        // --- 4. MESSAGING LOGIC ---
        async function handleSend() {
            const text = dom.inp.value.trim();
            if (!text) return;

            // Check if user has ANY keys
            if (!keys.groq && !keys.gemini) {
                alert("Please enter an API Key in Settings ‚öôÔ∏è");
                toggleModal(true);
                return;
            }

            // UI Updates
            dom.inp.value = '';
            dom.inp.style.height = 'auto';
            renderMessage(text, 'user');
            history.push({ role: 'user', content: text });
            saveChat();

            // Check for Art Generation
            if (/^(draw|paint|image)/i.test(text)) {
                if (!keys.hf) { renderMessage("‚ö†Ô∏è Need HuggingFace key for art.", "ai"); return; }
                renderMessage("üé® Painting...", "ai", true); // Temporary loading msg
                await generateArt(text);
                return;
            }

            // Text Generation
            const loaderId = showLoader();
            
            let response = null;
            let usedEngine = "None";

            // Try Groq First
            if (keys.groq) {
                try {
                    response = await callGroq();
                    usedEngine = "Groq";
                } catch (e) { console.error("Groq Failed", e); }
            }

            // Try Gemini Backup
            if (!response && keys.gemini) {
                try {
                    response = await callGemini();
                    usedEngine = "Gemini";
                } catch (e) { console.error("Gemini Failed", e); }
            }

            removeLoader(loaderId);

            if (response) {
                renderMessage(response, 'ai');
                history.push({ role: 'assistant', content: response });
                saveChat();
            } else {
                renderMessage(`‚ö†Ô∏è Error: Could not connect to ${usedEngine}. Check your keys.`, "ai");
            }
        }

        // --- 5. API CALLS ---
        async function callGroq() {
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${keys.groq}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "llama-3.3-70b-versatile",
                    messages: [{role: "system", content: "You are helpful."}, ...history]
                })
            });
            if (!res.ok) throw new Error("Groq Error " + res.status);
            const data = await res.json();
            return data.choices[0].message.content;
        }

        async function callGemini() {
            // Format for Gemini
            const parts = history.map(m => ({
                role: m.role === 'user' ? 'user' : 'model',
                parts: [{ text: m.content }]
            }));
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${keys.gemini}`, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: parts })
            });
            if (!res.ok) throw new Error("Gemini Error " + res.status);
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function generateArt(prompt) {
            try {
                const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${keys.hf}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ inputs: prompt.replace(/^(draw|paint|image)\s/i, '') })
                });
                if(!res.ok) throw new Error("Art Error");
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                
                // Remove the "Painting..." text
                dom.feed.lastChild.remove();
                
                const div = document.createElement('div');
                div.className = "msg ai";
                div.innerHTML = `<img src="${url}" class="img-result">`;
                dom.feed.appendChild(div);
                scrollToBottom();
            } catch (e) {
                dom.feed.lastChild.innerHTML = "‚ö†Ô∏è Art generation failed.";
            }
        }

        // --- 6. UI HELPERS ---
        function renderMessage(text, role, isTemp = false) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            if (role === 'ai' && !isTemp) {
                div.innerHTML = marked.parse(text);
                // Highlight Code
                div.querySelectorAll('pre code').forEach((el) => {
                    hljs.highlightElement(el);
                });
            } else {
                div.innerText = text;
            }
            dom.feed.appendChild(div);
            scrollToBottom();
            return div;
        }

        function showLoader() {
            const div = document.createElement('div');
            div.className = "msg ai";
            div.innerText = "...";
            div.id = "loader";
            dom.feed.appendChild(div);
            scrollToBottom();
            return "loader";
        }

        function removeLoader(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function saveChat() {
            localStorage.setItem('ai_chat_v3', JSON.stringify(history));
        }

        function clearChat() {
            if (confirm("Clear History?")) {
                history = [];
                localStorage.removeItem('ai_chat_v3');
                dom.feed.innerHTML = '';
            }
        }

        function scrollToBottom() {
            dom.feed.scrollTop = dom.feed.scrollHeight;
        }

        // Input Resize
        dom.inp.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    </script>
</body>
</html>
