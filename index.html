<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="theme-color" content="#09090b">
    <title>Ultimate AI Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark-dimmed.min.css">

    <style>
        :root {
            --bg: #09090b;
            --surface: #18181b;
            --border: #27272a;
            --accent: #10b981;
            --text-main: #f4f4f5;
            --font-stack: -apple-system, BlinkMacSystemFont, "Inter", Roboto, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: var(--font-stack);
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* App-like feel */
        }

        /* --- HEADER --- */
        header {
            height: 60px;
            padding: 0 20px;
            background: rgba(9, 9, 11, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
        }

        .brand { font-weight: 700; font-size: 17px; display: flex; align-items: center; gap: 10px; }
        .status-badge { font-size: 10px; font-weight: 600; padding: 4px 8px; border-radius: 20px; background: rgba(16, 185, 129, 0.1); color: var(--accent); border: 1px solid rgba(16, 185, 129, 0.2); }

        /* --- PULL TO REFRESH INDICATOR --- */
        #ptr {
            position: absolute;
            top: 60px; /* Below header */
            left: 0; right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* Let touches pass through */
            z-index: 40;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .ptr-icon {
            width: 24px; height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            transition: transform 0.2s;
        }

        #ptr.loading .ptr-icon { animation: spin 0.8s linear infinite; border-color: var(--border); border-top-color: var(--accent); }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- CHAT FEED --- */
        #feed {
            flex: 1;
            overflow-y: scroll;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            scroll-behavior: smooth;
            /* Important for Pull to Refresh feels */
            overscroll-behavior-y: contain; 
            position: relative;
            z-index: 45; /* Above PTR */
            background: transparent; 
        }

        /* MESSAGES & MARKDOWN */
        .msg-row { display: flex; width: 100%; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .u-row { justify-content: flex-end; }
        .a-row { justify-content: flex-start; }

        .msg { max-width: 90%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.6; box-shadow: 0 2px 5px rgba(0,0,0,0.2); word-wrap: break-word;}
        .u-msg { background: #2563eb; color: #fff; border-bottom-right-radius: 4px; }
        .a-msg { background: var(--surface); color: #ececec; border-bottom-left-radius: 4px; border: 1px solid var(--border); }

        .msg pre { background: #0d0d0d; padding: 12px; border-radius: 10px; overflow-x: auto; margin: 10px 0; border: 1px solid #333; position: relative; }
        .msg code { font-family: monospace; font-size: 13px; }
        .copy-btn { position: absolute; top: 5px; right: 5px; background: #333; border: none; color: #ccc; font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; }

        /* --- INPUT AREA --- */
        .input-container {
            background: var(--bg);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            display: flex; align-items: flex-end; gap: 12px; z-index: 50;
        }

        textarea {
            flex: 1; background: var(--surface); border: 1px solid var(--border); color: #fff;
            padding: 12px 16px; font-size: 16px; max-height: 120px; border-radius: 20px; resize: none; font-family: inherit;
        }
        
        #send-btn {
            width: 45px; height: 45px; border-radius: 50%; background: #fff; color: #000;
            border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        #send-btn:active { transform: scale(0.9); }
        
        .art-result { width: 100%; border-radius: 12px; margin-top: 5px; border: 1px solid #333; }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <span>‚ú¶ Ultimate AI</span>
        </div>
        <div id="status-badge" class="status-badge">READY</div>
        <div onclick="clearChat()" style="opacity:0.5; cursor:pointer">üóëÔ∏è</div>
    </header>

    <div id="ptr"><div class="ptr-icon"></div></div>

    <div id="feed">
        <div class="msg-row a-row">
            <div class="msg a-msg">
                <strong>System Online.</strong><br>
                Pull down to refresh. Type "Draw [idea]" for art.
            </div>
        </div>
    </div>

    <div class="input-container">
        <textarea id="inp" rows="1" placeholder="Ask anything..."></textarea>
        <button id="send-btn">‚û§</button>
    </div>

    <script src="env.js"></script>

    <script>
        const dom = {
            inp: document.getElementById('inp'),
            feed: document.getElementById('feed'),
            ptr: document.getElementById('ptr'),
            badge: document.getElementById('status-badge')
        };
        let chatHistory = [];
        let KEYS = { GROQ: "", GEMINI: "", HF: "" };

        // --- PULL TO REFRESH LOGIC ---
        let touchStart = 0;
        let ptrActive = false;

        dom.feed.addEventListener('touchstart', (e) => {
            if (dom.feed.scrollTop === 0) {
                touchStart = e.touches[0].clientY;
                ptrActive = true;
            }
        }, { passive: true });

        dom.feed.addEventListener('touchmove', (e) => {
            if (!ptrActive || dom.feed.scrollTop > 0) return;
            
            const touchY = e.touches[0].clientY;
            const pull = touchY - touchStart;

            if (pull > 0) {
                // If pulling down at top
                dom.ptr.style.opacity = '1';
                // Move header/feed down slightly for visual feel (optional, here we just rotate icon)
                const rotation = Math.min(pull, 360);
                dom.ptr.querySelector('.ptr-icon').style.transform = `rotate(${rotation}deg)`;
                
                if (pull > 80) { // Threshold to trigger
                    dom.ptr.querySelector('.ptr-icon').style.borderColor = '#10b981'; // Green when ready
                }
            }
        }, { passive: true });

        dom.feed.addEventListener('touchend', (e) => {
            if (!ptrActive) return;
            const touchEnd = e.changedTouches[0].clientY;
            if (touchEnd - touchStart > 80 && dom.feed.scrollTop === 0) {
                // Trigger Refresh
                dom.ptr.classList.add('loading');
                dom.badge.innerText = "RELOADING...";
                setTimeout(() => window.location.reload(), 500);
            } else {
                // Cancel
                dom.ptr.style.opacity = '0';
                dom.ptr.querySelector('.ptr-icon').style.borderColor = '#27272a';
            }
            ptrActive = false;
            touchStart = 0;
        });

        // --- MAIN CHAT LOGIC ---
        
        window.onload = () => {
            if(typeof CONFIG !== 'undefined') KEYS = CONFIG;
            dom.inp.focus();
        };

        marked.setOptions({
            highlight: (code, lang) => highlight.highlight(code, { language: highlight.getLanguage(lang) ? lang : 'plaintext' }).value
        });

        dom.inp.addEventListener('input', function() {
            this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        dom.inp.addEventListener('keydown', (e) => {
            if(e.key==="Enter" && !e.shiftKey) { e.preventDefault(); handleSend(); }
        });
        document.getElementById('send-btn').addEventListener('click', handleSend);

        async function handleSend() {
            const text = dom.inp.value.trim();
            if(!text) return;
            
            addMessage(text, 'user');
            dom.inp.value = ''; dom.inp.style.height = 'auto';

            if(/^(draw|paint|image|generate|lukis)\s/i.test(text)) {
                if(!KEYS.HF) return addMessage("‚ö†Ô∏è Missing HF Key in env.js", 'ai');
                setStatus("PAINTING...", "#d946ef");
                await generateArt(text);
            } else {
                if(!KEYS.GROQ && !KEYS.GEMINI) return addMessage("‚ö†Ô∏è Missing Chat Keys in env.js", 'ai');
                
                setStatus("THINKING...", "#fbbf24");
                const loader = addLoader();
                chatHistory.push({role: "user", content: text});

                let response = KEYS.GROQ ? await callGroq() : null;
                if(!response && KEYS.GEMINI) response = await callGemini();

                removeLoader(loader);
                if(response) {
                    addMessage(response, 'ai');
                    chatHistory.push({role: "assistant", content: response});
                } else {
                    addMessage("‚ö†Ô∏è Error: Servers busy.", 'ai');
                }
            }
            setStatus("READY", "#10b981");
        }

        async function callGroq() {
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: {"Authorization": `Bearer ${KEYS.GROQ}`, "Content-Type": "application/json"},
                    body: JSON.stringify({model: "llama-3.3-70b-versatile", messages: [{role:"system", content:"You are helpful."}, ...chatHistory]})
                });
                return (await res.json()).choices[0].message.content;
            } catch(e) { return null; }
        }

        async function callGemini() {
            try {
                const parts = chatHistory.map(m => ({role: m.role==="user"?"user":"model", parts:[{text: m.content}]}));
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${KEYS.GEMINI}`, {
                    method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({contents: parts})
                });
                return (await res.json()).candidates[0].content.parts[0].text;
            } catch(e) { return null; }
        }

        async function generateArt(p) {
            try {
                const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", {
                    method: "POST", headers: {Authorization: `Bearer ${KEYS.HF}`, "Content-Type": "application/json"},
                    body: JSON.stringify({inputs: p.replace(/^draw\s/i, '')})
                });
                const url = URL.createObjectURL(await res.blob());
                dom.feed.innerHTML += `<div class="msg-row a-row"><div class="msg a-msg"><img src="${url}" class="art-result"></div></div>`;
                dom.feed.scrollTop = dom.feed.scrollHeight;
            } catch(e) { addMessage("‚ö†Ô∏è Art Failed", 'ai'); }
        }

        function addMessage(txt, sender) {
            const d = document.createElement('div');
            d.className = `msg-row ${sender==='user'?'u-row':'a-row'}`;
            d.innerHTML = `<div class="msg ${sender==='user'?'u-msg':'a-msg'}">${sender==='ai'?marked.parse(txt):txt}</div>`;
            dom.feed.appendChild(d);
            
            // Add Copy Buttons
            if(sender === 'ai') {
                d.querySelectorAll('pre').forEach(p => {
                    const b = document.createElement('button');
                    b.className = 'copy-btn'; b.innerText = 'Copy';
                    b.onclick = () => { navigator.clipboard.writeText(p.innerText); b.innerText = 'Copied!'; setTimeout(()=>b.innerText='Copy',1000); };
                    p.appendChild(b);
                });
            }
            dom.feed.scrollTop = dom.feed.scrollHeight;
        }

        function addLoader() {
            const id = "l-" + Date.now();
            dom.feed.insertAdjacentHTML('beforeend', `<div id="${id}" class="msg-row a-row"><div class="msg a-msg">...</div></div>`);
            dom.feed.scrollTop = dom.feed.scrollHeight;
            return id;
        }
        function removeLoader(id) { document.getElementById(id)?.remove(); }
        function setStatus(t, c) { dom.badge.innerText=t; dom.badge.style.color=c; dom.badge.style.borderColor=c; }
        function clearChat() { chatHistory=[]; dom.feed.innerHTML=''; addMessage("Reset.", 'ai'); }
    </script>
</body>
</html>
