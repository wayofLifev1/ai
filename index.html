<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Ultimate AI: Master</title>
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* --- MASTER VARIABLES --- */
        :root {
            --bg: #000000;
            --surface: #141414;
            --surface-2: #222222;
            --accent: #007aff;
            --text: #ffffff;
            --dim: #888;
            --border: #333;
        }

        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; 
            margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; 
        }

        /* HEADER */
        header {
            height: 60px; padding: 0 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(20,20,20,0.9); backdrop-filter: blur(20px); z-index: 50;
        }
        .brand { font-weight: 700; font-size: 18px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .tag { font-size: 9px; background: linear-gradient(45deg, #007aff, #00c6ff); padding: 3px 6px; border-radius: 4px; color: white; font-weight: bold; }
        .head-btn { background: none; border: none; font-size: 18px; padding: 8px; cursor: pointer; opacity: 0.7; transition: 0.2s; }
        .head-btn:hover { opacity: 1; }

        /* FEED */
        #feed { 
            flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 24px; 
            scroll-behavior: smooth;
        }
        
        .msg-row { display: flex; width: 100%; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .user-row { justify-content: flex-end; }
        .ai-row { justify-content: flex-start; }
        
        .msg { 
            max-width: 88%; padding: 12px 18px; border-radius: 20px; font-size: 15px; line-height: 1.6; 
            position: relative; word-wrap: break-word; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .user-msg { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
        .ai-msg { background: var(--surface-2); color: #ececec; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        
        /* ATTACHMENT CARDS */
        .file-card {
            background: rgba(255,255,255,0.08); border-radius: 12px; padding: 10px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.1);
        }
        .file-icon { font-size: 24px; }
        .file-info { display: flex; flex-direction: column; overflow: hidden; }
        .file-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-type { font-size: 11px; color: rgba(255,255,255,0.5); }
        .img-preview { width: 100%; border-radius: 12px; margin-bottom: 8px; display: block; max-width: 300px; border: 1px solid #333; }
        .model-tag { font-size: 10px; color: #555; margin-top: 5px; text-align: right; display: block; font-family: monospace; }

        /* INPUT AREA */
        .input-area {
            background: var(--bg); border-top: 1px solid var(--border); padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; gap: 10px; z-index: 50;
        }
        
        .preview-zone { 
            display: none; background: var(--surface-2); padding: 8px 12px; border-radius: 12px; 
            font-size: 12px; color: var(--dim); border: 1px solid var(--border); align-items: center; justify-content: space-between;
        }
        
        .controls { display: flex; align-items: flex-end; gap: 8px; }
        
        .tool-btn { 
            width: 42px; height: 42px; border-radius: 50%; border: 1px solid var(--border); 
            background: var(--surface); color: var(--text); display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; flex-shrink: 0; transition: 0.2s;
        }
        .tool-btn:active { transform: scale(0.95); background: #333; }
        
        textarea {
            flex: 1; background: var(--surface); border: 1px solid var(--border); color: white;
            padding: 12px 16px; border-radius: 24px; font-size: 16px; resize: none; max-height: 120px; font-family: inherit;
        }
        
        #send-btn {
            width: 42px; height: 42px; border-radius: 50%; background: var(--accent); color: white; border: none;
            display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0;
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.4);
        }

        /* MODAL */
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: #181818; padding: 24px; border-radius: 24px; width: 90%; max-width: 360px; border: 1px solid #444; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; color: #888; font-size: 11px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .input-group input { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; font-size: 14px; box-sizing: border-box; transition: 0.2s; }
        .input-group input:focus { border-color: var(--accent); outline: none; }
        .save-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; margin-top: 5px; }
        
        pre { background: #0b0b0b !important; padding: 15px; border-radius: 12px; border: 1px solid #333; overflow-x: auto; margin: 15px 0; }
        code { font-family: 'Fira Code', monospace; font-size: 13px; }
    </style>
</head>
<body>

    <div id="modal">
        <div class="modal-box">
            <h2 style="margin-top:0; font-size:20px; margin-bottom:20px">‚öôÔ∏è Connectivity</h2>
            <div class="input-group">
                <label>Gemini API (Best for Files)</label>
                <input type="password" id="key-gemini" placeholder="AIza...">
            </div>
            <div class="input-group">
                <label>Groq API (Fast Text)</label>
                <input type="password" id="key-groq" placeholder="gsk_...">
            </div>
            <div class="input-group">
                <label>HuggingFace (Art & Backup Vision)</label>
                <input type="password" id="key-hf" placeholder="hf_...">
            </div>
            <button class="save-btn" onclick="saveKeys()">Save & Connect</button>
            <button id="install-btn" class="save-btn" style="background:#28cd41; display:none; margin-top:10px">üì≤ Install App</button>
            <button onclick="dom.modal.style.display='none'" style="width:100%; padding:12px; background:none; border:none; color:#666; margin-top:5px; font-weight:600">Cancel</button>
        </div>
    </div>

    <header>
        <div class="brand"><span>‚ú¶</span> Ultimate AI <span class="tag">MASTER</span></div>
        <div style="display:flex; gap: 8px;">
            <button class="head-btn" onclick="clearChat()">üóëÔ∏è</button>
            <button class="head-btn" onclick="dom.modal.style.display='flex'">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="feed"></div>

    <div class="input-area">
        <div id="preview-zone" class="preview-zone">
            <div style="display:flex; align-items:center; gap:10px">
                <span id="preview-icon" style="font-size:20px">üìÑ</span>
                <div style="display:flex; flex-direction:column">
                    <span id="preview-name" style="color:white; font-weight:600">file.pdf</span>
                    <span style="font-size:10px; color:#666">Attached</span>
                </div>
            </div>
            <button onclick="clearFile()" style="background:none; border:none; color:#ff453a; font-weight:bold; cursor:pointer">‚úï</button>
        </div>

        <div class="controls">
            <input type="file" id="file-input" accept="image/*,application/pdf,text/plain" style="display:none" onchange="handleFile(this)">
            
            <button class="tool-btn" onclick="document.getElementById('file-input').click()">üìé</button>
            <button class="tool-btn" id="mic-btn" onclick="toggleVoice()">üéôÔ∏è</button>
            
            <textarea id="inp" rows="1" placeholder="Message..."></textarea>
            
            <button id="send-btn" onclick="handleSend()">‚û§</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const dom = {
            feed: document.getElementById('feed'),
            inp: document.getElementById('inp'),
            modal: document.getElementById('modal'),
            preview: document.getElementById('preview-zone'),
            keys: { groq: document.getElementById('key-groq'), gemini: document.getElementById('key-gemini'), hf: document.getElementById('key-hf') }
        };

        let state = {
            keys: { groq: "", gemini: "", hf: "" },
            history: [],
            currentFile: null,
            installPrompt: null
        };

        // --- 2. LOAD ---
        window.onload = () => {
            const k = localStorage.getItem('uai_keys_v4');
            if(k) {
                state.keys = JSON.parse(k);
                dom.keys.groq.value = state.keys.groq;
                dom.keys.gemini.value = state.keys.gemini;
                dom.keys.hf.value = state.keys.hf;
            } else dom.modal.style.display = 'flex';

            const h = localStorage.getItem('uai_hist_v4');
            if(h) {
                state.history = JSON.parse(h);
                state.history.forEach(renderMessage);
            } else {
                renderMessage({ role: 'ai', content: "System Online.\n\nI can see, hear, and create." });
            }
        };

        // --- 3. FILE SYSTEM ---
        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            if(file.size > 20 * 1024 * 1024) return alert("File max 20MB");

            const reader = new FileReader();
            reader.onload = (e) => {
                state.currentFile = { name: file.name, type: file.type, data: e.target.result };
                dom.preview.style.display = 'flex';
                document.getElementById('preview-name').innerText = file.name;
                document.getElementById('preview-icon').innerText = file.type.startsWith('image/') ? 'üñºÔ∏è' : 'üìÑ';
            };
            reader.readAsDataURL(file);
        }
        function clearFile() { state.currentFile = null; dom.preview.style.display='none'; document.getElementById('file-input').value=""; }

        // --- 4. MAIN INTELLIGENCE ---
        async function handleSend() {
            const text = dom.inp.value.trim();
            const file = state.currentFile;
            
            if(!text && !file) return;

            // Render User
            const userMsg = { role: 'user', content: text, file: file ? {...file} : null };
            renderMessage(userMsg);
            state.history.push(userMsg);
            saveData();
            
            dom.inp.value = ''; clearFile();
            const loader = showLoader();
            let response = null;
            let usedModel = "";

            try {
                // A. ART GENERATION (HF)
                if(/^(draw|paint|generate)/i.test(text) && !file) {
                    if(!state.keys.hf) throw new Error("Need HuggingFace Key");
                    await generateArt(text);
                    removeLoader(loader); 
                    return;
                }

                // B. VISION / FILES
                if(file) {
                    if(state.keys.gemini) {
                        // Priority 1: Gemini (Best for everything)
                        usedModel = "Gemini 1.5 Flash";
                        response = await callGeminiMultimodal(text, file);
                    } 
                    else if(file.type.startsWith('image/') && state.keys.hf) {
                        // Priority 2: Hugging Face (Backup for Images)
                        usedModel = "HF (ViLT-B32)";
                        response = await callHuggingFaceVision(text, file);
                    } 
                    else {
                        throw new Error("For files, I need a Gemini Key (Best) or HuggingFace Key (Images only).");
                    }
                } 
                // C. TEXT ONLY
                else {
                    if(state.keys.groq) { usedModel = "Llama 3 70B"; response = await callGroq(); }
                    else if(state.keys.gemini) { usedModel = "Gemini 1.5"; response = await callGeminiMultimodal(text, null); }
                    else throw new Error("Please add an API Key.");
                }

                removeLoader(loader);
                if(response) {
                    const aiMsg = { role: 'ai', content: response, model: usedModel };
                    renderMessage(aiMsg);
                    state.history.push(aiMsg);
                    saveData();
                }

            } catch(e) {
                removeLoader(loader);
                renderMessage({ role: 'ai', content: `‚ö†Ô∏è **Error:** ${e.message}` });
            }
        }

        // --- 5. ENGINES ---
        
        // 1. Gemini (Files & Text)
        async function callGeminiMultimodal(prompt, fileObj) {
            const parts = [];
            if(prompt) parts.push({ text: prompt });
            if(fileObj) parts.push({ inlineData: { mimeType: fileObj.type, data: fileObj.data.split(',')[1] } });

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.keys.gemini}`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        }

        // 2. Groq (Fast Text)
        async function callGroq() {
            const msgs = [{role:"system", content:"You are a helpful AI."}, ...state.history.map(m => ({role: m.role==='user'?'user':'assistant', content: m.content || "Attached file"}))];
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST", headers: {Authorization: `Bearer ${state.keys.groq}`, "Content-Type": "application/json"},
                body: JSON.stringify({model: "llama-3.3-70b-versatile", messages: msgs})
            });
            return (await res.json()).choices[0].message.content;
        }

        // 3. Hugging Face Vision (Backup for Images)
        async function callHuggingFaceVision(prompt, fileObj) {
            // Model: Visual Question Answering
            const res = await fetch("https://api-inference.huggingface.co/models/dandelin/vilt-b32-finetuned-vqa", {
                method: "POST", headers: { Authorization: `Bearer ${state.keys.hf}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    inputs: {
                        image: fileObj.data.split(',')[1], // Base64
                        question: prompt || "Describe this image"
                    }
                })
            });
            
            if(!res.ok) throw new Error("HF Vision Error (Model loading or busy)");
            const data = await res.json();
            // HF VQA returns array of scores usually, we take the top answer
            if(Array.isArray(data) && data.length > 0) {
                // Usually returns [{answer: "cat", score: 0.9}, ...]
                return `**Analysis:** ${data[0].answer} (Confidence: ${Math.round(data[0].score*100)}%)`;
            }
            return JSON.stringify(data);
        }

        // 4. Hugging Face Art
        async function generateArt(prompt) {
            const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", {
                method: "POST", headers: {Authorization: `Bearer ${state.keys.hf}`, "Content-Type": "application/json"},
                body: JSON.stringify({inputs: prompt.replace(/^(draw|paint|generate)\s/i, '')})
            });
            const url = URL.createObjectURL(await res.blob());
            dom.feed.innerHTML += `<div class="msg-row ai-row"><div class="msg ai-msg"><img src="${url}" class="img-preview"><span class="model-tag">FLUX.1</span></div></div>`;
            scrollToBottom();
        }

        // --- 6. UTILS ---
        function renderMessage(msg) {
            const div = document.createElement('div');
            div.className = `msg-row ${msg.role === 'user' ? 'user-row' : 'ai-row'}`;
            let html = "";
            
            if(msg.file) {
                if(msg.file.type.startsWith('image/')) html += `<img src="${msg.file.data}" class="img-preview">`;
                else html += `<div class="file-card"><span class="file-icon">üìÑ</span><div class="file-info"><span class="file-name">${msg.file.name}</span><span class="file-type">${msg.file.type}</span></div></div>`;
            }
            if(msg.content) html += msg.role==='ai' ? marked.parse(msg.content) : msg.content;
            if(msg.model) html += `<span class="model-tag">${msg.model}</span>`;

            div.innerHTML = `<div class="msg ${msg.role === 'user' ? 'user-msg' : 'ai-msg'}">${html}</div>`;
            dom.feed.appendChild(div);
            div.querySelectorAll('pre code').forEach(hljs.highlightElement);
            scrollToBottom();
        }

        function saveKeys() { state.keys = { groq: dom.keys.groq.value.trim(), gemini: dom.keys.gemini.value.trim(), hf: dom.keys.hf.value.trim() }; localStorage.setItem('uai_keys_v4', JSON.stringify(state.keys)); dom.modal.style.display = 'none'; }
        function saveData() { localStorage.setItem('uai_hist_v4', JSON.stringify(state.history)); }
        function showLoader() { const id="l"+Date.now(); dom.feed.insertAdjacentHTML('beforeend', `<div id="${id}" class="msg-row ai-row"><div class="msg ai-msg">Thinking...</div></div>`); scrollToBottom(); return id; }
        function removeLoader(id) { document.getElementById(id)?.remove(); }
        function scrollToBottom() { dom.feed.scrollTop = dom.feed.scrollHeight; }
        function clearChat() { if(confirm("Clear Memory?")) { state.history=[]; saveData(); dom.feed.innerHTML=''; } }
        
        // Voice
        let recognition;
        function toggleVoice() {
            if(!('webkitSpeechRecognition' in window)) return alert("Browser does not support Voice.");
            recognition = new webkitSpeechRecognition();
            recognition.onresult = (e) => dom.inp.value += e.results[0][0].transcript + " ";
            recognition.start();
        }
        
        // PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); state.installPrompt = e;
            const btn = document.getElementById('install-btn');
            btn.style.display = 'block';
            btn.onclick = () => { state.installPrompt.prompt(); btn.style.display='none'; };
        });
    </script>
</body>
</html>
