<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Ultimate AI: Workspace</title>
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root { 
            --bg: #000; --sidebar: #0a0a0a; --surface: #141414; 
            --border: #222; --accent: #2563eb; --text: #eee; --dim: #888;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; display: flex; height: 100dvh; overflow: hidden; }

        /* --- SIDEBAR (History) --- */
        #sidebar {
            width: 260px; background: var(--sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 100;
        }
        .side-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .new-chat-btn { width: 100%; padding: 10px; background: var(--accent); border: none; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        #chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { 
            padding: 10px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; color: var(--dim); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .chat-item:hover { background: var(--surface); color: white; }
        .chat-item.active { background: #1f1f1f; color: white; border: 1px solid #333; }
        
        /* Mobile Sidebar Toggle */
        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; transform: translateX(-100%); width: 80%; }
            #sidebar.open { transform: translateX(0); }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; }
            .overlay.active { display: block; }
        }

        /* --- MAIN CONTENT --- */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }

        /* Header */
        header { 
            height: 50px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); 
        }
        .menu-btn { background: none; border: none; font-size: 20px; color: white; cursor: pointer; }
        .persona-select { background: #111; border: 1px solid #333; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; }

        /* Chat Feed */
        #feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        .msg { max-width: 800px; margin: 0 auto; width: 100%; display: flex; gap: 15px; }
        .avatar { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .u-av { background: #333; } .a-av { background: var(--accent); }
        .msg-content { flex: 1; font-size: 15px; line-height: 1.6; padding-top: 4px; }
        
        /* Artifacts / Code */
        pre { background: #111; padding: 12px; border-radius: 8px; border: 1px solid #333; overflow-x: auto; position: relative; }
        .preview-btn { position: absolute; top: 10px; right: 10px; background: #222; border: 1px solid #444; color: white; font-size: 11px; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        .preview-btn:hover { background: var(--accent); border-color: var(--accent); }

        /* Input Area */
        .input-wrapper { max-width: 800px; margin: 0 auto; width: 100%; padding: 15px; }
        .input-box { 
            background: var(--surface); border: 1px solid var(--border); border-radius: 24px; 
            padding: 8px 12px; display: flex; align-items: flex-end; gap: 10px; position: relative;
        }
        
        .file-preview { position: absolute; bottom: 100%; left: 0; background: #222; padding: 8px; border-radius: 8px; border: 1px solid #333; margin-bottom: 10px; display: none; align-items: center; gap: 10px; font-size: 12px; }
        
        textarea { flex: 1; background: transparent; border: none; color: white; resize: none; max-height: 120px; padding: 10px; font-family: inherit; font-size: 16px; }
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; color: #888; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { color: white; background: #222; }
        .send-btn { background: white; color: black; }
        .send-btn:hover { background: #ddd; }

        /* Live Preview Modal */
        #artifact-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; flex-direction: column; }
        .am-head { height: 50px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #111; }
        #artifact-frame { flex: 1; background: white; border: none; width: 100%; height: 100%; }

        /* Settings Modal */
        #settings-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; }
        .settings-box { background: #141414; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid #333; }
        .s-field { margin-bottom: 15px; }
        .s-field label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .s-field input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 6px; }
        
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleSide()"></div>

    <div id="sidebar">
        <div class="side-header">
            <span style="font-weight:700">Ultimate AI</span>
            <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </div>
        <div style="padding:15px 10px 0 10px;">
            <button class="new-chat-btn" onclick="newChat()">+ New Chat</button>
        </div>
        <div id="chat-list">
            </div>
    </div>

    <div id="main">
        <header>
            <div style="display:flex; align-items:center; gap:10px">
                <button class="menu-btn" onclick="toggleSide()">‚ò∞</button>
                <select id="persona" class="persona-select" onchange="changePersona()">
                    <option value="helpful">ü§ñ Assistant</option>
                    <option value="coder">üë®‚Äçüíª Coder</option>
                    <option value="creative">üé® Creative</option>
                    <option value="brief">‚ö° Brief</option>
                </select>
            </div>
            <div id="model-status" style="font-size:11px; color:#555">READY</div>
        </header>

        <div id="feed">
            </div>

        <div class="input-wrapper">
            <div id="file-prev" class="file-preview">
                <span id="fp-name">file.pdf</span>
                <button onclick="clearFile()" style="background:none; border:none; color:red; cursor:pointer">‚úï</button>
            </div>
            <div class="input-box">
                <input type="file" id="file-in" style="display:none" onchange="handleFile(this)">
                <button class="icon-btn" onclick="document.getElementById('file-in').click()">üìé</button>
                <button class="icon-btn" onclick="toggleVoice()" id="mic-btn">üéôÔ∏è</button>
                <textarea id="inp" rows="1" placeholder="Type a message..."></textarea>
                <button class="icon-btn send-btn" onclick="send()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="artifact-modal">
        <div class="am-head">
            <span style="font-weight:600">Live Preview</span>
            <button onclick="closePreview()" style="background:none; border:none; color:white; cursor:pointer">Close ‚úï</button>
        </div>
        <iframe id="artifact-frame"></iframe>
    </div>

    <div id="settings-modal">
        <div class="settings-box">
            <h2 style="margin-top:0">‚öôÔ∏è API Keys</h2>
            <div class="s-field">
                <label>Gemini API</label>
                <input type="password" id="k-gem" placeholder="AIza...">
            </div>
            <div class="s-field">
                <label>Groq API</label>
                <input type="password" id="k-groq" placeholder="gsk_...">
            </div>
            <div class="s-field">
                <label>HuggingFace API</label>
                <input type="password" id="k-hf" placeholder="hf_...">
            </div>
            <button onclick="saveKeys()" class="new-chat-btn">Save Settings</button>
            <button onclick="document.getElementById('settings-modal').style.display='none'" style="width:100%; background:none; border:none; color:#666; margin-top:10px">Close</button>
        </div>
    </div>

    <script>
        // --- STATE & CONFIG ---
        const state = {
            keys: { gem: "", groq: "", hf: "" },
            chats: [], // Array of {id, title, msgs}
            activeChatId: null,
            file: null,
            personas: {
                helpful: "You are a helpful AI assistant.",
                coder: "You are an expert Senior Developer. Write clean, efficient code. When writing HTML, always put it in a single block.",
                creative: "You are a creative writer. Be vivid and imaginative.",
                brief: "Be extremely concise. No fluff."
            }
        };

        const dom = {
            feed: document.getElementById('feed'),
            inp: document.getElementById('inp'),
            list: document.getElementById('chat-list'),
            preview: document.getElementById('file-prev'),
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('overlay')
        };

        // --- INIT ---
        window.onload = () => {
            // Load Keys
            const k = localStorage.getItem('uai_keys');
            if(k) {
                state.keys = JSON.parse(k);
                document.getElementById('k-gem').value = state.keys.gem;
                document.getElementById('k-groq').value = state.keys.groq;
                document.getElementById('k-hf').value = state.keys.hf;
            } else openSettings();

            // Load Chats
            const c = localStorage.getItem('uai_chats');
            if(c) state.chats = JSON.parse(c);
            
            if(state.chats.length === 0) newChat();
            else loadChat(state.chats[0].id);

            renderChatList();
        };

        // --- CHAT MANAGEMENT ---
        function newChat() {
            const id = Date.now().toString();
            const newSession = { id: id, title: "New Chat", msgs: [] };
            state.chats.unshift(newSession);
            loadChat(id);
            if(window.innerWidth < 768) toggleSide();
        }

        function loadChat(id) {
            state.activeChatId = id;
            const chat = state.chats.find(c => c.id === id);
            dom.feed.innerHTML = '';
            
            if(chat.msgs.length === 0) {
                // Intro message
                addMsgToFeed({role: 'ai', content: "Hello! I am ready. Select a persona above ü§ñ or upload a file üìé."}, false);
            } else {
                chat.msgs.forEach(m => addMsgToFeed(m, false));
            }
            
            renderChatList();
            saveData();
        }

        function renderChatList() {
            dom.list.innerHTML = '';
            state.chats.forEach(c => {
                const div = document.createElement('div');
                div.className = `chat-item ${c.id === state.activeChatId ? 'active' : ''}`;
                div.innerHTML = `<span>${c.title}</span> <span style="float:right; opacity:0.5; font-size:10px" onclick="deleteChat('${c.id}', event)">‚úï</span>`;
                div.onclick = (e) => { if(e.target.tagName !== 'SPAN') loadChat(c.id); };
                dom.list.appendChild(div);
            });
        }

        function deleteChat(id, e) {
            e.stopPropagation();
            if(!confirm("Delete chat?")) return;
            state.chats = state.chats.filter(c => c.id !== id);
            if(state.chats.length === 0) newChat();
            else if(state.activeChatId === id) loadChat(state.chats[0].id);
            else renderChatList();
            saveData();
        }

        // --- MESSAGING ---
        async function send() {
            const txt = dom.inp.value.trim();
            if(!txt && !state.file) return;

            // 1. Add User Msg
            const userMsg = { role: 'user', content: txt, file: state.file ? {...state.file} : null };
            addMsg(userMsg);
            
            // Update Title if new
            const activeChat = state.chats.find(c => c.id === state.activeChatId);
            if(activeChat.msgs.length === 1) {
                activeChat.title = txt.substring(0, 30) || "Image Upload";
                renderChatList();
            }

            dom.inp.value = '';
            clearFile();

            // 2. Add Loader
            const loaderId = "l-" + Date.now();
            dom.feed.insertAdjacentHTML('beforeend', `<div id="${loaderId}" class="msg"><div class="avatar a-av">AI</div><div class="msg-content">...</div></div>`);
            scrollToBottom();

            try {
                let response = "";
                // Router
                if(/^(draw|paint)/i.test(txt) && !userMsg.file) {
                    await generateArt(txt);
                } else {
                    response = await getAIResponse(txt, userMsg.file);
                    addMsg({ role: 'ai', content: response });
                }
            } catch(e) {
                addMsg({ role: 'ai', content: "‚ö†Ô∏è Error: " + e.message });
            }
            
            document.getElementById(loaderId)?.remove();
        }

        function addMsg(msg) {
            // Add to data
            const chat = state.chats.find(c => c.id === state.activeChatId);
            chat.msgs.push(msg);
            saveData();
            addMsgToFeed(msg, true);
        }

        function addMsgToFeed(msg, animate) {
            const div = document.createElement('div');
            div.className = "msg";
            
            let content = "";
            if(msg.file) {
                 if(msg.file.type.startsWith('image')) content += `<img src="${msg.file.data}" style="max-width:200px; border-radius:8px; display:block; margin-bottom:10px">`;
                 else content += `<div style="background:#222; padding:10px; border-radius:8px; margin-bottom:10px">üìÑ ${msg.file.name}</div>`;
            }
            
            content += marked.parse(msg.content || "");

            div.innerHTML = `
                <div class="avatar ${msg.role==='user'?'u-av':'a-av'}">${msg.role==='user'?'U':'AI'}</div>
                <div class="msg-content">${content}</div>
            `;
            
            dom.feed.appendChild(div);
            
            // Artifact Detection (Live Preview)
            if(msg.role === 'ai') {
                div.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                    // Check if HTML/SVG
                    if(block.classList.contains('language-html') || block.classList.contains('language-xml')) {
                        const btn = document.createElement('button');
                        btn.className = 'preview-btn';
                        btn.innerText = 'üëÅÔ∏è Preview';
                        btn.onclick = () => showPreview(block.innerText);
                        block.parentElement.appendChild(btn);
                    }
                });
            }
            
            scrollToBottom();
        }

        // --- API ENGINES ---
        async function getAIResponse(txt, file) {
            const pKey = document.getElementById('persona').value;
            const systemPrompt = state.personas[pKey];

            if(file) {
                // Must use Gemini
                if(!state.keys.gem) throw new Error("Gemini Key required for files");
                return await callGemini(txt, file, systemPrompt);
            } else {
                // Prefer Groq
                if(state.keys.groq) return await callGroq(txt, systemPrompt);
                if(state.keys.gem) return await callGemini(txt, null, systemPrompt);
                throw new Error("No API Keys configured");
            }
        }

        async function callGroq(txt, sys) {
            // Get last 6 msgs for context
            const chat = state.chats.find(c => c.id === state.activeChatId);
            const hist = chat.msgs.slice(-6).map(m => ({role: m.role==='user'?'user':'assistant', content: m.content || "[File]"}));
            
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST", headers: {Authorization: `Bearer ${state.keys.groq}`, "Content-Type":"application/json"},
                body: JSON.stringify({model: "llama-3.3-70b-versatile", messages: [{role:"system", content:sys}, ...hist]})
            });
            return (await res.json()).choices[0].message.content;
        }

        async function callGemini(txt, file, sys) {
            let parts = [{text: sys + "\n\nUser: " + (txt || "Describe this")}];
            if(file) parts.push({ inlineData: { mimeType: file.type, data: file.data.split(',')[1] } });
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.keys.gem}`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });
            return (await res.json()).candidates[0].content.parts[0].text;
        }

        async function generateArt(txt) {
            if(!state.keys.hf) throw new Error("HuggingFace Key needed for art");
            const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", {
                method: "POST", headers: {Authorization: `Bearer ${state.keys.hf}`, "Content-Type":"application/json"},
                body: JSON.stringify({inputs: txt.replace(/^(draw|paint)\s/i, '')})
            });
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            addMsg({ role: 'ai', content: `Here is your image:\n\n![Art](${url})` }); // Markdown image
        }

        // --- UTILS ---
        function handleFile(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                state.file = { name: f.name, type: f.type, data: e.target.result };
                document.getElementById('fp-name').innerText = f.name;
                dom.preview.style.display = 'flex';
            };
            r.readAsDataURL(f);
        }
        function clearFile() { state.file = null; dom.preview.style.display='none'; }
        
        function showPreview(code) {
            const frame = document.getElementById('artifact-frame');
            frame.srcdoc = code;
            document.getElementById('artifact-modal').style.display = 'flex';
        }
        function closePreview() { document.getElementById('artifact-modal').style.display = 'none'; }
        
        function saveKeys() {
            state.keys = { gem: document.getElementById('k-gem').value, groq: document.getElementById('k-groq').value, hf: document.getElementById('k-hf').value };
            localStorage.setItem('uai_keys', JSON.stringify(state.keys));
            document.getElementById('settings-modal').style.display='none';
        }
        function saveData() { localStorage.setItem('uai_chats', JSON.stringify(state.chats)); }
        function openSettings() { document.getElementById('settings-modal').style.display='flex'; }
        function toggleSide() { 
            dom.sidebar.classList.toggle('open'); 
            dom.overlay.classList.toggle('active');
        }
        function scrollToBottom() { dom.feed.scrollTop = dom.feed.scrollHeight; }

        // Voice
        function toggleVoice() {
            if(!window.webkitSpeechRecognition) return alert("Not supported");
            const r = new webkitSpeechRecognition();
            r.onresult = e => dom.inp.value += e.results[0][0].transcript;
            r.start();
        }
        
        dom.inp.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; });
    </script>
</body>
</html>
