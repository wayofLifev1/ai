<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#fdfbf7">
    <title>AI Workspace</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #fdfbf7; --bg-sidebar: #f4f1ea; --bg-surface: #ffffff;
            --bg-user: #e8e4dc; --text-main: #2d2a26; --text-muted: #8c8682;
            --accent: #8d7b68; --border: #e6e2dd; --glass: rgba(253, 251, 247, 0.95);
            --font-main: 'Plus Jakarta Sans', sans-serif; --font-code: 'JetBrains Mono', monospace;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-main); background: var(--bg-body); margin: 0; display: flex; height: 100vh; height: 100dvh; color: var(--text-main); overflow: hidden; }

        /* UI STYLES */
        #sidebar { width: 280px; background: var(--bg-sidebar); display: flex; flex-direction: column; transition: transform 0.3s ease; position: absolute; height: 100%; z-index: 1000; transform: translateX(-100%); border-right: 1px solid var(--border); }
        @media (min-width: 850px) { #sidebar { position: relative; transform: translateX(0); } }
        #sidebar.open { transform: translateX(0); box-shadow: 100vw 0 0 rgba(0,0,0,0.2); }
        
        .btn-new { width: 100%; padding: 14px; background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .history-list { flex: 1; overflow-y: auto; padding: 0 15px; }
        .history-item { padding: 12px; margin-bottom: 4px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .history-item.active { background: white; border: 1px solid var(--border); font-weight: 700; }
        .del-btn { opacity: 0; color: #b3261e; padding: 4px; }
        .history-item.active .del-btn { opacity: 1; }

        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--glass); backdrop-filter: blur(10px); z-index: 10; border-bottom: 1px solid rgba(0,0,0,0.03); position: absolute; width: 100%; top:0; }
        
        #chatContainer { flex: 1; overflow-y: auto; padding: 80px 5% 180px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; width: 100%; max-width: 900px; margin: 0 auto; }
        
        .message-wrapper { display: flex; gap: 12px; opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } from { opacity: 0; transform: translateY(10px); } }
        .message-wrapper.user { justify-content: flex-end; }
        .avatar { width: 28px; height: 28px; border-radius: 8px; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 4px; }
        .message { max-width: 85%; font-size: 1rem; line-height: 1.6; word-wrap: break-word; }
        .message.user { background: var(--bg-user); padding: 10px 16px; border-radius: 18px; border-top-right-radius: 4px; }
        .message.error { color: #b3261e; background: #ffebee; border: 1px solid #ffcdd2; }

        .input-dock { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, var(--bg-body) 90%, transparent); padding: 10px 20px calc(20px + var(--safe-bottom)); z-index: 20; }
        .input-box { background: var(--bg-surface); border-radius: 26px; padding: 8px 14px; border: 1px solid var(--border); box-shadow: 0 5px 20px rgba(0,0,0,0.04); display: flex; flex-direction: column; max-width: 900px; margin: 0 auto; }
        .main-input-row { display: flex; align-items: flex-end; gap: 8px; }
        textarea { width: 100%; background: transparent; border: none; padding: 12px 0; resize: none; outline: none; font-family: inherit; font-size: 1rem; max-height: 140px; }
        .send-btn { background: var(--accent); color: white; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: none; cursor: pointer; }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-muted); }

        #settingsOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); z-index: 2000; }
        .modal { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; }
        .field input, .field textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-top: 5px; margin-bottom: 15px; }
        
        /* Code & Math Styling */
        .code-wrap { margin: 15px 0; border: 1px solid #333; border-radius: 8px; overflow: hidden; background: #1e1e1e; }
        .code-head { padding: 6px 12px; background: #2d2d2d; color: #aaa; font-size: 0.75rem; display: flex; justify-content: space-between; }
        pre { margin: 0; padding: 12px; overflow-x: auto; color: white; }
        .katex { font-size: 1.1em; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="padding: 30px 20px 0;">
        <button class="btn-new" onclick="newChat()"> <span class="material-icons-round">add</span> New Chat </button>
    </div>
    <div class="history-list" id="historyList"></div>
    <div style="padding: 20px; border-top: 1px solid var(--border);">
        <button class="icon-btn" style="width:100%; border-radius:12px; display:flex; gap:10px; padding:12px;" onclick="toggleSettings()"> <span class="material-icons-round">settings</span> Settings </button>
    </div>
</div>

<div class="main-content">
    <header>
        <button class="icon-btn" onclick="document.getElementById('sidebar').classList.toggle('open')"> <span class="material-icons-round">menu</span> </button>
        <span style="font-weight:600;">Workspace</span>
        <button class="icon-btn" onclick="toggleSettings()"> <span class="material-icons-round">tune</span> </button>
    </header>

    <div id="chatContainer">
        <div style="text-align:center; margin-top:20vh; opacity:0.6;">
            <h1 style="color:var(--accent);">Assalamualaikum</h1>
            <p>Please set your API Key in Settings to start.</p>
        </div>
    </div>

    <div class="input-dock">
        <div class="input-box">
            <div class="main-input-row">
                <textarea id="userInput" rows="1" placeholder="Type a message..."></textarea>
                <button id="sendBtn" class="send-btn" onclick="send()"> <span class="material-icons-round">arrow_upward</span> </button>
            </div>
        </div>
    </div>
</div>

<div id="settingsOverlay">
    <div class="modal">
        <h3 style="margin-top:0">Settings</h3>
        <div class="field"> <label>Groq API Key (Required)</label> <input type="password" id="groqKey" placeholder="gsk_..."> </div>
        <div class="field"> <label>System Prompt</label> <textarea id="sysPrompt" rows="3">You are a helpful assistant.</textarea> </div>
        <button class="btn-new" style="background:var(--accent); color:white; justify-content:center;" onclick="saveSettings()">Save & Close</button>
        <div style="font-size:0.8rem; color:#b3261e; margin-top:10px;">* Keys are stored on your device only.</div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(e => console.log('SW Error:', e));

    const renderer = new marked.Renderer();
    renderer.code = function(code, lang) {
        return `<div class="code-wrap"><div class="code-head"><span>${lang||'text'}</span></div><pre><code class="hljs ${lang}">${hljs.highlightAuto(code).value}</code></pre></div>`;
    };
    marked.use({ renderer });

    let state = { chats: JSON.parse(localStorage.getItem('chats')||'[]'), id: null };

    function init() {
        document.getElementById('groqKey').value = localStorage.getItem('groqKey') || '';
        document.getElementById('sysPrompt').value = localStorage.getItem('sysPrompt') || 'You are a helpful assistant.';
        if(state.chats.length) renderHist(); else newChat();
    }

    // --- 2. SEND MESSAGE LOGIC ---
    async function send() {
        const text = document.getElementById('userInput').value.trim();
        const apiKey = document.getElementById('groqKey').value.trim();

        if (!text) return;
        
        // CHECK API KEY
        if (!apiKey) {
            alert("Please enter your Groq API Key in Settings.");
            toggleSettings();
            return;
        }

        // 1. UI: User Message
        appendMsg('user', text);
        document.getElementById('userInput').value = '';
        
        // 2. Data: Save Chat
        if(!state.id) newChat();
        const chat = state.chats.find(c => c.id === state.id);
        chat.messages.push({ role: 'user', content: text });
        if(chat.messages.length===1) { chat.title = text.slice(0,25); renderHist(); }
        save();

        // 3. UI: AI Placeholder
        const aiMsgDiv = appendMsg('ai', '<span style="color:#888">Thinking...</span>');
        
        try {
            // 4. API Call (Robust Version)
            const msgs = [
                { role: "system", content: document.getElementById('sysPrompt').value },
                ...chat.messages.slice(-8)
            ];

            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "llama-3.3-70b-versatile",
                    messages: msgs,
                    stream: true 
                })
            });

            if (!res.ok) {
                const errData = await res.json().catch(()=>({}));
                throw new Error(errData.error?.message || `API Error: ${res.status}`);
            }

            // 5. Stream Reader (Fixed for reliability)
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = "";
            let buffer = ""; // Holds incomplete chunks

            aiMsgDiv.innerHTML = ""; // Clear "Thinking..."

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep last incomplete line

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed.startsWith("data: ") && trimmed !== "data: [DONE]") {
                        try {
                            const json = JSON.parse(trimmed.replace("data: ", ""));
                            const chunk = json.choices[0]?.delta?.content || "";
                            fullResponse += chunk;
                            aiMsgDiv.innerHTML = marked.parse(fullResponse);
                            scrollToBottom();
                        } catch (e) { console.error("Parse error", e); }
                    }
                }
            }

            // 6. Save AI Response
            chat.messages.push({ role: 'ai', content: fullResponse });
            save();
            renderMath(aiMsgDiv); // Math rendering
            aiMsgDiv.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));

        } catch (error) {
            aiMsgDiv.innerHTML = `⚠️ <b>Error:</b> ${error.message}`;
            aiMsgDiv.classList.add('error');
        }
    }

    // --- 3. UTILITIES ---
    function appendMsg(role, html) {
        document.querySelector('#chatContainer > div').style.display = 'none'; // Hide welcome
        const div = document.createElement('div');
        div.className = `message-wrapper ${role}`;
        div.innerHTML = `
            ${role==='ai'?'<div class="avatar"><span class="material-icons-round">smart_toy</span></div>':''}
            <div class="message ${role}">${role==='user' ? html.replace(/\n/g,'<br>') : html}</div>
        `;
        document.getElementById('chatContainer').appendChild(div);
        scrollToBottom();
        return div.querySelector('.message');
    }

    function renderMath(el) {
        if(window.renderMathInElement) {
            renderMathInElement(el, {delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}], throwOnError:false});
        }
    }

    function newChat() { state.id = Date.now().toString(); state.chats.unshift({id:state.id, title:"New Chat", messages:[]}); save(); document.getElementById('chatContainer').innerHTML='<div style="text-align:center;margin-top:20vh;opacity:0.6;"><h1 style="color:var(--accent);">Assalamualaikum</h1><p>Type to start.</p></div>'; renderHist(); if(window.innerWidth<850)document.getElementById('sidebar').classList.remove('open'); }
    function renderHist() { const l=document.getElementById('historyList'); l.innerHTML=''; state.chats.forEach(c=>{ const d=document.createElement('div'); d.className=`history-item ${c.id===state.id?'active':''}`; d.innerHTML=`<span>${c.title}</span><span class="material-icons-round del-btn" onclick="delChat('${c.id}',event)">delete</span>`; d.onclick=(e)=>{if(!e.target.closest('.del-btn'))loadChat(c.id)}; l.appendChild(d); }); }
    function loadChat(id) { state.id=id; const c=state.chats.find(x=>x.id===id); document.getElementById('chatContainer').innerHTML=''; c.messages.forEach(m=>appendMsg(m.role, m.content)); renderHist(); if(window.innerWidth<850)document.getElementById('sidebar').classList.remove('open'); }
    function delChat(id,e) { e.stopPropagation(); if(confirm("Delete?")){ state.chats=state.chats.filter(x=>x.id!==id); save(); state.chats.length?loadChat(state.chats[0].id):newChat(); } }
    function save() { localStorage.setItem('chats', JSON.stringify(state.chats)); }
    function scrollToBottom() { const c = document.getElementById('chatContainer'); c.scrollTop = c.scrollHeight; }
    function toggleSettings() { const el = document.getElementById('settingsOverlay'); el.style.display=el.style.display==='flex'?'none':'flex'; }
    function saveSettings() { localStorage.setItem('groqKey', document.getElementById('groqKey').value); localStorage.setItem('sysPrompt', document.getElementById('sysPrompt').value); toggleSettings(); }
    
    // Auto resize text
    document.getElementById('userInput').addEventListener('input', function() { this.style.height='auto';this.style.height=Math.min(this.scrollHeight,140)+'px'; });

    init();
</script>
</body>
</html>
